<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- TAMBAHKAN META TAG INI UNTUK CACHE CONTROL -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistem SDN RAWABUNTU 03</title>
    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- ðŸ”¥ FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- INCLUDE FIREBASE-APP.JS (SINGLE SOURCE OF TRUTH) -->
    <script src="firebase-app.js?v=2"></script>
    
    <style>
        :root {
            --primary-blue: #2c3e50;
            --secondary-blue: #3498db;
            --success-green: #27ae60;
            --warning-orange: #f39c12;
            --danger-red: #e74c3c;
            --light-gray: #f8f9fa;
            --dark-gray: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Navigation */
        .navbar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--secondary-blue);
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: var(--light-gray);
            border-radius: 20px;
        }

        .btn-logout {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: var(--light-gray);
        }

        .tab-btn.active {
            background: var(--secondary-blue);
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .stat-students { background: #e3f2fd; color: var(--secondary-blue); }
        .stat-attendance { background: #e8f5e9; color: var(--success-green); }
        .stat-scores { background: #fff3e0; color: var(--warning-orange); }
        .stat-classes { background: #f3e5f5; color: #9c27b0; }

        .stat-info h3 {
            font-size: 2rem;
            margin: 0;
            font-weight: 700;
        }

        .stat-info p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.95rem;
        }

        /* Download Section */
        .download-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary-blue);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--secondary-blue);
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .download-card {
            background: var(--light-gray);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid var(--secondary-blue);
            transition: all 0.3s;
        }

        .download-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .download-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--secondary-blue);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .download-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-download {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-excel {
            background: var(--success-green);
            color: white;
        }

        .btn-pdf {
            background: var(--danger-red);
            color: white;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Student Management */
        .student-management {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-add {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        /* Student Table */
        .student-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .student-table th {
            background: var(--primary-blue);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .student-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .student-table tbody tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .btn-delete {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success { background: var(--success-green); }
        .notification.error { background: var(--danger-red); }
        .notification.info { background: var(--secondary-blue); }

        /* Button Groups */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-edit {
            background: var(--warning-orange);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #d68910;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* Class Badge */
        .class-badge {
            display: inline-block;
            background: var(--secondary-blue);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        /* Admin Tools Section - DITAMBAHKAN */
        .admin-tools {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .danger-zone {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left: 5px solid var(--danger-red);
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
        }

        .tool-card {
            background: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .tool-card h4 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-card h4 i {
            color: var(--secondary-blue);
        }

        .tool-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .tool-actions button {
            flex: 1;
            min-width: 150px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: var(--warning-orange);
            color: white;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        /* Edit Student Modal - DITAMBAHKAN */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: var(--danger-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                justify-content: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .student-table {
                display: block;
                overflow-x: auto;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-group {
                flex-direction: column;
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-item {
                width: 100%;
            }

            .tool-actions {
                flex-direction: column;
            }

            .tool-actions button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="logo">
                <i class="fas fa-school"></i>
                <span>SDN RAWABUNTU 03 - ADMIN</span>
            </div>
        </div>
        <div class="navbar-right">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="adminEmail">admin@rbt.com</span>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </button>
            <button class="tab-btn" data-tab="download">
                <i class="fas fa-download"></i>
                Download Laporan
            </button>
            <button class="tab-btn" data-tab="students">
                <i class="fas fa-user-graduate"></i>
                Manajemen Siswa
            </button>
            <button class="tab-btn" data-tab="admin-tools">
                <i class="fas fa-tools"></i>
                Admin Tools
            </button>
            <button class="tab-btn" data-tab="attendance">
                <i class="fas fa-calendar-check"></i>
                Absensi
            </button>
            <button class="tab-btn" data-tab="scores">
                <i class="fas fa-chart-bar"></i>
                Nilai
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-students">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalStudents">0</h3>
                        <p>Total Siswa</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-attendance">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="attendanceRate">0%</h3>
                        <p>Kehadiran Hari Ini</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-scores">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="averageScore">0</h3>
                        <p>Rata-rata Nilai</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-classes">
                        <i class="fas fa-chalkboard"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalClasses">0</h3>
                        <p>Total Kelas</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="download-section">
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Aksi Cepat
                </h2>
                
                <!-- Filter untuk Download Data -->
                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: var(--dark-gray);">
                        <i class="fas fa-filter"></i> Pilih Kelas untuk Download
                    </h3>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label class="form-label">Pilih Kelas</label>
                            <select id="dashboardClassFilter" class="form-control">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Pilih Semester</label>
                            <select id="dashboardSemesterFilter" class="form-control">
                                <option value="all">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="download-grid">
                    <!-- Download Data Siswa -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h4>Data Siswa</h4>
                                <p>Download data siswa berdasarkan kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadStudentsExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadStudentsPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Download Absensi -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h4>Data Absensi</h4>
                                <p>Download data absensi per kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadAttendanceByClassExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadAttendanceByClassPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Download Nilai -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>
                                <h4>Data Nilai</h4>
                                <p>Download data nilai per kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadScoresByClassExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadScoresByClassPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Download Laporan Lengkap -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div>
                                <h4>Laporan Lengkap</h4>
                                <p>Download semua data per kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadCompleteReportByClassExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadCompleteReportByClassPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download Laporan Tab -->
        <div id="download-tab" class="tab-content">
            <div class="download-section">
                <h2 class="section-title">
                    <i class="fas fa-download"></i>
                    Download Laporan Lengkap
                </h2>
                <p style="margin-bottom: 25px; color: #666;">
                    Pilih jenis laporan yang ingin diunduh dalam format Excel atau PDF.
                </p>

                <!-- Filter Options -->
                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: var(--dark-gray);">
                        <i class="fas fa-filter"></i> Filter Data
                    </h3>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label class="form-label">Pilih Kelas</label>
                            <select id="filterClass" class="form-control">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Semester</label>
                            <select id="filterSemester" class="form-control">
                                <option value="all">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Bulan</label>
                            <select id="filterMonth" class="form-control">
                                <option value="all">Semua Bulan</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Tahun Ajaran</label>
                            <input type="number" id="filterYear" class="form-control" value="2024" min="2020" max="2030">
                        </div>
                    </div>
                </div>

                <!-- Download Cards -->
                <div class="download-grid">
                    <!-- Laporan Absensi -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h4>Laporan Absensi</h4>
                                <p>Data kehadiran siswa berdasarkan kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadAttendanceExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadAttendancePDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Laporan Nilai -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>
                                <h4>Laporan Nilai</h4>
                                <p>Data nilai siswa berdasarkan kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadScoresExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadScoresPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Laporan Lengkap -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div>
                                <h4>Laporan Lengkap</h4>
                                <p>Absensi + Nilai berdasarkan kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadCompleteReportExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadCompleteReportPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>

                    <!-- Laporan Statistik -->
                    <div class="download-card">
                        <div class="download-header">
                            <div class="download-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>
                                <h4>Ringkasan Statistik</h4>
                                <p>Analisis data per kelas</p>
                            </div>
                        </div>
                        <div class="download-actions">
                            <button class="btn-download btn-excel" onclick="downloadStatisticsExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="btn-download btn-pdf" onclick="downloadStatisticsPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manajemen Siswa Tab -->
        <div id="students-tab" class="tab-content">
            <div class="student-management">
                <h2 class="section-title">
                    <i class="fas fa-user-graduate"></i>
                    Manajemen Data Siswa
                </h2>

                <!-- Form Tambah Siswa -->
                <div style="background: var(--light-gray); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark-gray);">
                        <i class="fas fa-user-plus"></i> Tambah Siswa Baru
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Pilih Kelas *</label>
                            <select id="addClass" class="form-control" required>
                                <option value="">Pilih Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap Siswa *</label>
                            <input type="text" id="addName" class="form-control" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin *</label>
                            <select id="addGender" class="form-control" required>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Lahir</label>
                            <input type="date" id="addBirthDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Orang Tua/Wali</label>
                            <input type="text" id="addParent" class="form-control" placeholder="Nama orang tua/wali">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-add" onclick="addStudent()">
                            <i class="fas fa-plus"></i>
                            Tambah Siswa
                        </button>
                        <button class="btn-add" style="background: var(--warning-orange);" onclick="clearStudentForm()">
                            <i class="fas fa-redo"></i>
                            Reset Form
                        </button>
                    </div>
                </div>

                <!-- Daftar Siswa -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--dark-gray);">
                            <i class="fas fa-list"></i> Daftar Siswa
                        </h3>
                        <div class="btn-group">
                            <!-- Filter Kelas -->
                            <div>
                                <label class="form-label">Filter Kelas:</label>
                                <select id="listClass" class="form-control" style="width: 200px;" onchange="loadStudentList()">
                                    <option value="all">Semua Kelas</option>
                                    <!-- Classes will be populated by JavaScript -->
                                </select>
                            </div>
                            <button class="btn-add" style="background: var(--secondary-blue);" onclick="refreshStudentList()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="student-table-container">
                        <div id="studentList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Memuat data siswa...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tools Tab - DITAMBAHKAN -->
        <div id="admin-tools-tab" class="tab-content">
            <div class="admin-tools">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                    Admin Tools
                </h2>
                <p style="margin-bottom: 25px; color: #666;">
                    Fitur khusus untuk administrator. Gunakan dengan hati-hati!
                </p>

                <!-- Edit Siswa -->
                <div class="tool-card">
                    <h4><i class="fas fa-user-edit"></i> Edit Data Siswa</h4>
                    <p>Edit data siswa termasuk jenis kelamin dan status.</p>
                    <div class="filter-row" style="margin-top: 15px;">
                        <div class="filter-item">
                            <label class="form-label">Pilih Kelas</label>
                            <select id="editClass" class="form-control">
                                <option value="">Pilih Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Pilih Siswa</label>
                            <select id="editStudent" class="form-control">
                                <option value="">Pilih Siswa</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <button class="btn-edit" onclick="loadStudentForEdit()" style="margin-top: 25px;">
                                <i class="fas fa-search"></i> Cari Siswa
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Hapus Nilai -->
                <div class="tool-card">
                    <h4><i class="fas fa-trash-alt"></i> Hapus Data Nilai</h4>
                    <p>Hapus data nilai siswa secara keseluruhan atau berdasarkan kelas.</p>
                    <div class="tool-actions">
                        <button class="btn-danger" onclick="deleteScores('all')">
                            <i class="fas fa-trash"></i> Hapus Semua Nilai
                        </button>
                        <button class="btn-danger" onclick="deleteScores('class')">
                            <i class="fas fa-users"></i> Hapus Nilai Per Kelas
                        </button>
                        <button class="btn-danger" onclick="deleteScores('student')">
                            <i class="fas fa-user"></i> Hapus Nilai Per Siswa
                        </button>
                    </div>
                </div>

                <!-- Hapus Absensi -->
                <div class="tool-card">
                    <h4><i class="fas fa-calendar-times"></i> Hapus Data Absensi</h4>
                    <p>Hapus data absensi siswa secara keseluruhan atau berdasarkan kelas.</p>
                    <div class="tool-actions">
                        <button class="btn-danger" onclick="deleteAttendance('all')">
                            <i class="fas fa-trash"></i> Hapus Semua Absensi
                        </button>
                        <button class="btn-danger" onclick="deleteAttendance('class')">
                            <i class="fas fa-users"></i> Hapus Absensi Per Kelas
                        </button>
                        <button class="btn-danger" onclick="deleteAttendance('student')">
                            <i class="fas fa-user"></i> Hapus Absensi Per Siswa
                        </button>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="danger-zone">
                    <h4><i class="fas fa-exclamation-triangle"></i> Zona Berbahaya</h4>
                    <p style="color: #721c24; margin-bottom: 15px;">
                        <strong>PERINGATAN:</strong> Aksi ini tidak dapat dibatalkan. Data yang dihapus akan hilang selamanya!
                    </p>
                    <div class="tool-actions">
                        <button class="btn-danger" onclick="deleteAllData()" style="background: #dc3545;">
                            <i class="fas fa-fire"></i> Hapus SEMUA Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Absensi Tab -->
        <div id="attendance-tab" class="tab-content">
            <div class="download-section">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    Data Absensi
                </h2>
                
                <!-- Filter untuk Data Absensi -->
                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: var(--dark-gray);">
                        <i class="fas fa-filter"></i> Filter Data Absensi
                    </h3>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label class="form-label">Pilih Kelas</label>
                            <select id="attendanceClassFilter" class="form-control">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Tanggal Mulai</label>
                            <input type="date" id="attendanceStartDate" class="form-control">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Tanggal Akhir</label>
                            <input type="date" id="attendanceEndDate" class="form-control">
                        </div>
                        <div class="filter-item">
                            <button class="btn-add" onclick="loadAttendanceData()">
                                <i class="fas fa-search"></i>
                                Filter
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="attendanceData">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Memuat data absensi...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Nilai Tab -->
        <div id="scores-tab" class="tab-content">
            <div class="download-section">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Data Nilai
                </h2>
                
                <!-- Filter untuk Data Nilai -->
                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: var(--dark-gray);">
                        <i class="fas fa-filter"></i> Filter Data Nilai
                    </h3>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label class="form-label">Pilih Kelas</label>
                            <select id="scoresClassFilter" class="form-control">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Semester</label>
                            <select id="scoresSemesterFilter" class="form-control">
                                <option value="all">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <button class="btn-add" onclick="loadScoresData()">
                                <i class="fas fa-search"></i>
                                Filter
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="scoresData">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Memuat data nilai...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal - DITAMBAHKAN -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i> Edit Data Siswa
                </div>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div id="editStudentForm">
                <!-- Form will be populated by JavaScript -->
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Memuat data siswa...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let allClasses = [];
        let allStudents = {};
        let currentUser = null;
        let auth = null;
        let database = null;
        let studentsData = {}; // Store student data for edit

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸš€ Admin system initializing...");
            
            // CLEAR CACHE ON LOAD
            clearBrowserCache();
            
            // Tunda inisialisasi untuk memastikan Firebase SDK sudah dimuat
            setTimeout(() => {
                initializeAdminSystem();
            }, 500);
        });

        async function initializeAdminSystem() {
            try {
                console.log("ðŸ”¥ Checking Firebase initialization...");
                
                // Cek apakah Firebase sudah siap
                if (typeof firebase === 'undefined') {
                    console.error("âŒ Firebase SDK not loaded. Please refresh page.");
                    showNotification("Firebase SDK tidak terdeteksi. Silakan refresh halaman.", "error");
                    return;
                }
                
                // Get Firebase services
                if (window.firebaseApp && window.firebaseApp.isInitialized) {
                    console.log("âœ… Using firebase-app.js services");
                    auth = window.firebaseApp.getAuth();
                    database = window.firebaseApp.getDatabase();
                } else {
                    console.log("âš ï¸ firebase-app.js not ready, using direct Firebase");
                    if (!firebase.apps.length) {
                        const firebaseConfig = {
                            apiKey: "AIzaSyD_0hKhrz0vC7X_9KRrXiTOnRGI9Pi6tBI",
                            authDomain: "absensi-dan-penilaian-siswa.firebaseapp.com",
                            databaseURL: "https://absensi-dan-penilaian-siswa-default-rtdb.asia-southeast1.firebasedatabase.app",
                            projectId: "absensi-dan-penilaian-siswa",
                            storageBucket: "absensi-dan-penilaian-siswa.appspot.com",
                            messagingSenderId: "774655798848",
                            appId: "1:774655798848:web:d6ddb5a04d4acd91d1b9a5"
                        };
                        firebase.initializeApp(firebaseConfig);
                    }
                    auth = firebase.auth();
                    database = firebase.database();
                }
                
                if (!auth || !database) {
                    throw new Error("Firebase services initialization failed");
                }
                
                console.log("âœ… Firebase services loaded successfully");
                
                // Check authentication
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        console.log("âš ï¸ User not authenticated, redirecting to login...");
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    currentUser = user;
                    document.getElementById('adminEmail').textContent = user.email;
                    
                    // Check if user is admin
                    const userInfo = window.firebaseApp?.teacherMapping?.[user.email];
                    if (!userInfo || userInfo.role !== 'admin') {
                        showNotification("Akses ditolak. Hanya admin yang dapat mengakses halaman ini.", "error");
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    }
                    
                    console.log("âœ… Admin authenticated:", user.email);
                    initializeAdminPage();
                });
                
                // Set default dates
                const today = new Date();
                const defaultDate = new Date(today.getFullYear() - 10, today.getMonth(), today.getDate());
                document.getElementById('addBirthDate').value = defaultDate.toISOString().split('T')[0];
                
                // Set default dates for attendance filter
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                document.getElementById('attendanceStartDate').value = oneWeekAgo.toISOString().split('T')[0];
                document.getElementById('attendanceEndDate').value = today.toISOString().split('T')[0];
                
            } catch (error) {
                console.error("âŒ Error initializing admin system:", error);
                showNotification("Gagal menginisialisasi sistem: " + error.message, "error");
                
                // Fallback: try to reload page
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }

        function clearBrowserCache() {
            if (window.performance && window.performance.navigation && window.performance.navigation.type === 1) {
                window.location.reload(true);
            }
            
            localStorage.removeItem('adminCacheTimestamp');
            localStorage.removeItem('adminClasses');
            localStorage.removeItem('adminStudents');
        }

        function checkForCacheUpdate() {
            const cacheTimestamp = localStorage.getItem('adminCacheTimestamp');
            const currentTimestamp = new Date().getTime();
            
            if (cacheTimestamp && (currentTimestamp - parseInt(cacheTimestamp)) > 300000) {
                console.log("ðŸ”„ Cache expired, refreshing...");
                clearBrowserCache();
                window.location.reload();
            }
        }

        // ============================================
        // ADMIN PAGE FUNCTIONS
        // ============================================
        function initializeAdminPage() {
            setupTabNavigation();
            loadInitialData();
            setupEventListeners();
            
            setInterval(checkForCacheUpdate, 60000);
            setInterval(loadInitialData, 30000);
            
            console.log("âœ… Admin page initialized");
        }

        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabElement = document.getElementById(`${tabId}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Add active class to clicked button
            const buttonElement = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Load tab data if needed
            if (tabId === 'students') {
                loadStudentList();
            } else if (tabId === 'attendance') {
                loadAttendanceData();
            } else if (tabId === 'scores') {
                loadScoresData();
            } else if (tabId === 'admin-tools') {
                populateEditClassDropdown();
            }
        }

        function setupEventListeners() {
            const addNameInput = document.getElementById('addName');
            if (addNameInput) {
                addNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addStudent();
                    }
                });
            }
            
            // When edit class changes, load students
            const editClassSelect = document.getElementById('editClass');
            if (editClassSelect) {
                editClassSelect.addEventListener('change', function() {
                    populateEditStudentDropdown(this.value);
                });
            }
        }

        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        async function loadInitialData() {
            try {
                console.log("ðŸ“Š Loading initial data...");
                
                // Pastikan database tersedia
                if (!database) {
                    console.error("âŒ Database not available");
                    return;
                }
                
                // Load classes from students data
                const classesSnapshot = await database.ref('students').once('value');
                const studentsData = classesSnapshot.val() || {};
                allClasses = Object.keys(studentsData).sort();
                
                // Update total classes
                document.getElementById('totalClasses').textContent = allClasses.length;
                
                // Populate class dropdowns
                populateClassDropdowns();
                
                // Load all students data
                allStudents = {};
                let totalStudents = 0;
                
                for (const className of allClasses) {
                    const studentsSnapshot = await database.ref(`students/${className}`).once('value');
                    const classStudents = studentsSnapshot.val() || {};
                    allStudents[className] = classStudents;
                    totalStudents += Object.keys(classStudents).length;
                }
                
                document.getElementById('totalStudents').textContent = totalStudents;
                
                // Load attendance data for today
                await loadTodayAttendance();
                
                // Load average scores
                await loadAverageScores();
                
                // Update cache timestamp
                localStorage.setItem('adminCacheTimestamp', new Date().getTime().toString());
                
                console.log("âœ… Initial data loaded successfully");
                
            } catch (error) {
                console.error("âŒ Error loading initial data:", error);
                showNotification("Gagal memuat data: " + error.message, "error");
            }
        }

        function populateClassDropdowns() {
            const dropdowns = [
                document.getElementById('filterClass'),
                document.getElementById('addClass'),
                document.getElementById('listClass'),
                document.getElementById('dashboardClassFilter'),
                document.getElementById('attendanceClassFilter'),
                document.getElementById('scoresClassFilter')
            ];
            
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    // Save current value
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '';
                    
                    if (dropdown.id === 'filterClass' || dropdown.id === 'listClass' || 
                        dropdown.id === 'dashboardClassFilter' || dropdown.id === 'attendanceClassFilter' || 
                        dropdown.id === 'scoresClassFilter') {
                        const allOption = document.createElement('option');
                        allOption.value = "all";
                        allOption.textContent = "Semua Kelas";
                        dropdown.appendChild(allOption);
                    } else {
                        const placeholder = document.createElement('option');
                        placeholder.value = "";
                        placeholder.textContent = "Pilih Kelas";
                        dropdown.appendChild(placeholder);
                    }
                    
                    // Add class options
                    allClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = `Kelas ${className}`;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore previous value if it exists
                    if (currentValue && (currentValue === "all" || allClasses.includes(currentValue))) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        function populateEditClassDropdown() {
            const dropdown = document.getElementById('editClass');
            if (!dropdown) return;
            
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="">Pilih Kelas</option>';
            
            allClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = `Kelas ${className}`;
                dropdown.appendChild(option);
            });
            
            if (currentValue && allClasses.includes(currentValue)) {
                dropdown.value = currentValue;
                populateEditStudentDropdown(currentValue);
            }
        }

        async function populateEditStudentDropdown(className) {
            const dropdown = document.getElementById('editStudent');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Pilih Siswa</option>';
            
            if (!className) return;
            
            const classStudents = allStudents[className] || {};
            
            for (const studentId in classStudents) {
                const student = classStudents[studentId];
                const option = document.createElement('option');
                option.value = studentId;
                option.textContent = `${student.nama} (${studentId})`;
                option.setAttribute('data-gender', student.jenis_kelamin || 'L');
                option.setAttribute('data-status', student.status || 'aktif');
                dropdown.appendChild(option);
            }
        }

        async function loadTodayAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                let totalStudents = 0;
                let presentCount = 0;
                
                for (const className of allClasses) {
                    const attendanceSnapshot = await database.ref(`attendance/${className}/${today}`).once('value');
                    const attendanceData = attendanceSnapshot.val() || {};
                    
                    const classStudents = allStudents[className] || {};
                    totalStudents += Object.keys(classStudents).length;
                    
                    Object.values(attendanceData).forEach(record => {
                        if (typeof record === 'object') {
                            if (record.status === 'hadir' || record.status === 'H') {
                                presentCount++;
                            }
                        } else if (record === 'hadir' || record === 'H') {
                            presentCount++;
                        }
                    });
                }
                
                const attendanceRate = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                
            } catch (error) {
                console.error("Error loading attendance:", error);
                document.getElementById('attendanceRate').textContent = "0%";
            }
        }

        async function loadAverageScores() {
            try {
                let totalScore = 0;
                let scoreCount = 0;
                
                for (const className of allClasses) {
                    const scoresSnapshot = await database.ref(`penilaian/${className}`).once('value');
                    const scoresData = scoresSnapshot.val() || {};
                    
                    for (const semester in scoresData) {
                        for (const studentId in scoresData[semester]) {
                            const studentScore = scoresData[semester][studentId];
                            if (studentScore.nilai_total) {
                                totalScore += parseFloat(studentScore.nilai_total);
                                scoreCount++;
                            }
                        }
                    }
                }
                
                const averageScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
                document.getElementById('averageScore').textContent = averageScore;
                
            } catch (error) {
                console.error("Error loading scores:", error);
                document.getElementById('averageScore').textContent = "0";
            }
        }

        // ============================================
        // STUDENT MANAGEMENT FUNCTIONS
        // ============================================
        async function addStudent() {
            const className = document.getElementById('addClass').value;
            const name = document.getElementById('addName').value.trim();
            const gender = document.getElementById('addGender').value;
            const birthDate = document.getElementById('addBirthDate').value;
            const parent = document.getElementById('addParent').value.trim();

            // Validasi input
            if (!className) {
                showNotification("Pilih kelas terlebih dahulu", "error");
                return;
            }

            if (!name) {
                showNotification("Masukkan nama siswa", "error");
                return;
            }

            if (name.length < 3) {
                showNotification("Nama siswa minimal 3 karakter", "error");
                return;
            }

            // Create student data
            const studentData = {
                nama: name,
                kelas: className,
                jenis_kelamin: gender,
                tanggal_lahir: birthDate || '',
                nama_ortu: parent || '',
                tanggal_daftar: new Date().toISOString(),
                status: 'aktif'
            };

            try {
                showNotification("Menambahkan siswa...", "info");
                
                // Pastikan database tersedia
                if (!database) {
                    throw new Error("Database tidak tersedia");
                }
                
                // Save to Firebase
                const newStudentRef = database.ref(`students/${className}`).push();
                await newStudentRef.set(studentData);
                
                showNotification(`âœ… Siswa "${name}" berhasil ditambahkan ke kelas ${className}`, "success");
                
                // Reset form
                clearStudentForm();
                
                // Reload data
                await loadInitialData();
                await loadStudentList();
                
            } catch (error) {
                console.error("âŒ Error adding student:", error);
                showNotification("âŒ Gagal menambahkan siswa: " + error.message, "error");
            }
        }

        function clearStudentForm() {
            document.getElementById('addName').value = '';
            document.getElementById('addParent').value = '';
            document.getElementById('addBirthDate').value = new Date(new Date().getFullYear() - 10, 
                new Date().getMonth(), new Date().getDate()).toISOString().split('T')[0];
        }

        async function deleteStudent(className, studentId) {
            if (!confirm("âš ï¸ Apakah Anda yakin ingin menghapus siswa ini?\n\nData yang dihapus tidak dapat dikembalikan!")) {
                return;
            }

            try {
                // Pastikan database tersedia
                if (!database) {
                    throw new Error("Database tidak tersedia");
                }
                
                // Get student name before deleting
                const studentSnapshot = await database.ref(`students/${className}/${studentId}`).once('value');
                const studentData = studentSnapshot.val();
                const studentName = studentData?.nama || 'Siswa';
                
                showNotification("Menghapus siswa...", "info");
                
                // Delete student from database
                await database.ref(`students/${className}/${studentId}`).remove();
                
                showNotification(`âœ… Siswa "${studentName}" berhasil dihapus dari kelas ${className}`, "success");
                
                // Reload data
                await loadInitialData();
                await loadStudentList();
                
            } catch (error) {
                console.error("âŒ Error deleting student:", error);
                showNotification("âŒ Gagal menghapus siswa: " + error.message, "error");
            }
        }

        async function loadStudentList() {
            const container = document.getElementById('studentList');
            if (!container) return;

            try {
                const selectedClass = document.getElementById('listClass')?.value || 'all';
                
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Memuat data siswa...</p>
                    </div>
                `;
                
                let html = '';
                let studentCount = 0;
                
                if (selectedClass === 'all') {
                    html = `
                        <table class="student-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Jenis Kelamin</th>
                                    <th>Tanggal Lahir</th>
                                    <th>Orang Tua/Wali</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    for (const className of allClasses) {
                        const classStudents = allStudents[className] || {};
                        
                        for (const studentId in classStudents) {
                            const student = classStudents[studentId];
                            studentCount++;
                            
                            const birthDate = student.tanggal_lahir ? 
                                new Date(student.tanggal_lahir).toLocaleDateString('id-ID') : '-';
                            
                            const genderText = student.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan';
                            const statusBadge = student.status === 'aktif' ? 
                                '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;">AKTIF</span>' :
                                '<span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;">NON-AKTIF</span>';
                            
                            html += `
                                <tr>
                                    <td>${studentCount}</td>
                                    <td><strong>${student.nama || '-'}</strong></td>
                                    <td><span class="class-badge">${className}</span></td>
                                    <td>${genderText}</td>
                                    <td>${birthDate}</td>
                                    <td>${student.nama_ortu || '-'}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="openEditModal('${className}', '${studentId}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn-delete" onclick="deleteStudent('${className}', '${studentId}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                    
                    if (studentCount === 0) {
                        html = `
                            <div style="text-align: center; padding: 60px 20px; color: #666;">
                                <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                                <h3 style="margin-bottom: 10px;">Belum Ada Data Siswa</h3>
                                <p style="margin-bottom: 20px;">Silakan tambahkan siswa baru menggunakan form di atas.</p>
                                <button class="btn-add" onclick="document.getElementById('addClass').focus()">
                                    <i class="fas fa-plus"></i> Tambah Siswa Pertama
                                </button>
                            </div>
                        `;
                    } else {
                        html += `</tbody></table>`;
                        html += `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                                <strong>Total: ${studentCount} siswa</strong> dari ${allClasses.length} kelas
                            </div>
                        `;
                    }
                    
                } else {
                    const classStudents = allStudents[selectedClass] || {};
                    const studentIds = Object.keys(classStudents);
                    
                    if (studentIds.length === 0) {
                        html = `
                            <div style="text-align: center; padding: 60px 20px; color: #666;">
                                <i class="fas fa-user-graduate" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                                <h3 style="margin-bottom: 10px;">Tidak Ada Siswa di Kelas ${selectedClass}</h3>
                                <p style="margin-bottom: 20px;">Silakan tambahkan siswa baru untuk kelas ini.</p>
                                <button class="btn-add" onclick="document.getElementById('addClass').value='${selectedClass}'; document.getElementById('addName').focus()">
                                    <i class="fas fa-plus"></i> Tambah Siswa ke Kelas ${selectedClass}
                                </button>
                            </div>
                        `;
                    } else {
                        html = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4>Kelas ${selectedClass} - ${studentIds.length} Siswa</h4>
                                <button class="btn-add" style="background: var(--secondary-blue); padding: 8px 15px;" 
                                        onclick="document.getElementById('addClass').value='${selectedClass}'; document.getElementById('addName').focus()">
                                    <i class="fas fa-plus"></i> Tambah ke Kelas Ini
                                </button>
                            </div>
                            <table class="student-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Siswa</th>
                                        <th>Jenis Kelamin</th>
                                        <th>Tanggal Lahir</th>
                                        <th>Orang Tua/Wali</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        studentIds.forEach((studentId, index) => {
                            const student = classStudents[studentId];
                            const birthDate = student.tanggal_lahir ? 
                                new Date(student.tanggal_lahir).toLocaleDateString('id-ID') : '-';
                            
                            const genderText = student.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan';
                            const statusBadge = student.status === 'aktif' ? 
                                '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;">AKTIF</span>' :
                                '<span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;">NON-AKTIF</span>';
                            
                            html += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${student.nama || '-'}</strong></td>
                                    <td>${genderText}</td>
                                    <td>${birthDate}</td>
                                    <td>${student.nama_ortu || '-'}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="openEditModal('${selectedClass}', '${studentId}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn-delete" onclick="deleteStudent('${selectedClass}', '${studentId}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `</tbody></table>`;
                    }
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error("âŒ Error loading student list:", error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <h3>Gagal Memuat Data Siswa</h3>
                        <p style="margin-bottom: 20px;">${error.message}</p>
                        <button class="btn-add" onclick="loadStudentList()">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        function refreshStudentList() {
            loadInitialData().then(() => {
                loadStudentList();
                showNotification("Data siswa diperbarui", "success");
            });
        }

        // ============================================
        // ADMIN TOOLS FUNCTIONS - DITAMBAHKAN
        // ============================================

        // Fungsi untuk membuka modal edit siswa
        async function openEditModal(className, studentId) {
            try {
                // Load student data
                const studentRef = database.ref(`students/${className}/${studentId}`);
                const snapshot = await studentRef.once('value');
                const studentData = snapshot.val();
                
                if (!studentData) {
                    showNotification("Data siswa tidak ditemukan", "error");
                    return;
                }
                
                // Save data for later use
                studentsData = {
                    className: className,
                    studentId: studentId,
                    studentData: studentData
                };
                
                // Create edit form
                const formHtml = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Kelas</label>
                            <input type="text" class="form-control" value="${className}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ID Siswa</label>
                            <input type="text" class="form-control" value="${studentId}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" id="editName" class="form-control" value="${studentData.nama || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin *</label>
                            <select id="editGender" class="form-control" required>
                                <option value="L" ${studentData.jenis_kelamin === 'L' ? 'selected' : ''}>Laki-laki</option>
                                <option value="P" ${studentData.jenis_kelamin === 'P' ? 'selected' : ''}>Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Lahir</label>
                            <input type="date" id="editBirthDate" class="form-control" 
                                   value="${studentData.tanggal_lahir ? studentData.tanggal_lahir.split('T')[0] : ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Orang Tua/Wali</label>
                            <input type="text" id="editParent" class="form-control" value="${studentData.nama_ortu || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="editStatus" class="form-control">
                                <option value="aktif" ${studentData.status === 'aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="nonaktif" ${studentData.status === 'nonaktif' ? 'selected' : ''}>Nonaktif</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn-add" onclick="saveStudentEdit()">
                            <i class="fas fa-save"></i> Simpan Perubahan
                        </button>
                        <button class="btn-add" style="background: var(--warning-orange);" onclick="closeEditModal()">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                `;
                
                document.getElementById('editStudentForm').innerHTML = formHtml;
                document.getElementById('editStudentModal').classList.add('active');
                
            } catch (error) {
                console.error("Error loading student for edit:", error);
                showNotification("Gagal memuat data siswa untuk diedit", "error");
            }
        }

        // Fungsi untuk mencari siswa dari dropdown
        async function loadStudentForEdit() {
            const className = document.getElementById('editClass').value;
            const studentId = document.getElementById('editStudent').value;
            
            if (!className || !studentId) {
                showNotification("Pilih kelas dan siswa terlebih dahulu", "error");
                return;
            }
            
            await openEditModal(className, studentId);
        }

        // Fungsi untuk menyimpan edit siswa
        async function saveStudentEdit() {
            try {
                const { className, studentId, studentData } = studentsData;
                
                if (!className || !studentId) {
                    showNotification("Data siswa tidak valid", "error");
                    return;
                }
                
                // Get updated values
                const updates = {
                    nama: document.getElementById('editName').value.trim() || studentData.nama,
                    jenis_kelamin: document.getElementById('editGender').value,
                    tanggal_lahir: document.getElementById('editBirthDate').value || '',
                    nama_ortu: document.getElementById('editParent').value.trim() || '',
                    status: document.getElementById('editStatus').value
                };
                
                // Validate
                if (!updates.nama || updates.nama.length < 3) {
                    showNotification("Nama siswa minimal 3 karakter", "error");
                    return;
                }
                
                if (!['L', 'P'].includes(updates.jenis_kelamin)) {
                    showNotification("Jenis kelamin harus 'L' atau 'P'", "error");
                    return;
                }
                
                showNotification("Menyimpan perubahan...", "info");
                
                // Use firebaseApp function if available, otherwise direct Firebase
                if (window.firebaseApp && window.firebaseApp.updateStudent) {
                    await window.firebaseApp.updateStudent(studentId, className, updates);
                } else {
                    const studentRef = database.ref(`students/${className}/${studentId}`);
                    await studentRef.update(updates);
                }
                
                showNotification("âœ… Data siswa berhasil diperbarui", "success");
                closeEditModal();
                
                // Refresh data
                await loadInitialData();
                await loadStudentList();
                
            } catch (error) {
                console.error("Error saving student edit:", error);
                showNotification("Gagal menyimpan perubahan: " + error.message, "error");
            }
        }

        // Fungsi untuk menutup modal edit
        function closeEditModal() {
            document.getElementById('editStudentModal').classList.remove('active');
            studentsData = {};
        }

        // Fungsi untuk menghapus nilai
        async function deleteScores(scope) {
            try {
                let confirmMessage = '';
                let kelas = null;
                let studentId = null;
                
                switch(scope) {
                    case 'all':
                        confirmMessage = "âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA NILAI dari semua kelas.\n\nTindakan ini tidak dapat dibatalkan!";
                        if (!confirm(confirmMessage)) return;
                        break;
                        
                    case 'class':
                        kelas = prompt("Masukkan kelas yang nilainya akan dihapus (contoh: 1A, 2B):");
                        if (!kelas) return;
                        if (!allClasses.includes(kelas)) {
                            showNotification(`Kelas ${kelas} tidak ditemukan`, "error");
                            return;
                        }
                        confirmMessage = `âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA NILAI dari kelas ${kelas}.\n\nTindakan ini tidak dapat dibatalkan!`;
                        if (!confirm(confirmMessage)) return;
                        break;
                        
                    case 'student':
                        kelas = prompt("Masukkan kelas siswa:");
                        if (!kelas) return;
                        if (!allClasses.includes(kelas)) {
                            showNotification(`Kelas ${kelas} tidak ditemukan`, "error");
                            return;
                        }
                        studentId = prompt("Masukkan ID siswa:");
                        if (!studentId) return;
                        confirmMessage = `âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA NILAI untuk siswa ${studentId} di kelas ${kelas}.\n\nTindakan ini tidak dapat dibatalkan!`;
                        if (!confirm(confirmMessage)) return;
                        break;
                }
                
                showNotification("Menghapus data nilai...", "info");
                
                // Use firebaseApp function if available
                if (window.firebaseApp && window.firebaseApp.deleteAllScores) {
                    const result = await window.firebaseApp.deleteAllScores({
                        kelas: scope === 'all' ? null : kelas,
                        studentId: scope === 'student' ? studentId : null,
                        confirmation: false // Already confirmed
                    });
                    
                    if (result.success) {
                        showNotification(result.message, "success");
                    } else {
                        showNotification(result.message, "error");
                    }
                } else {
                    // Manual deletion
                    let path = 'penilaian';
                    if (kelas) {
                        path = `penilaian/${kelas}`;
                        if (studentId) {
                            path = `penilaian/${kelas}/*/${studentId}`;
                        }
                    }
                    
                    await database.ref(path).remove();
                    
                    const successMessage = scope === 'all' 
                        ? "Semua data nilai berhasil dihapus"
                        : scope === 'class'
                            ? `Data nilai kelas ${kelas} berhasil dihapus`
                            : `Data nilai siswa ${studentId} berhasil dihapus`;
                    
                    showNotification(successMessage, "success");
                }
                
                // Refresh data
                await loadInitialData();
                
            } catch (error) {
                console.error("Error deleting scores:", error);
                showNotification("Gagal menghapus data nilai: " + error.message, "error");
            }
        }

        // Fungsi untuk menghapus absensi
        async function deleteAttendance(scope) {
            try {
                let confirmMessage = '';
                let kelas = null;
                let studentId = null;
                
                switch(scope) {
                    case 'all':
                        confirmMessage = "âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA ABSENSI dari semua kelas.\n\nTindakan ini tidak dapat dibatalkan!";
                        if (!confirm(confirmMessage)) return;
                        break;
                        
                    case 'class':
                        kelas = prompt("Masukkan kelas yang absensinya akan dihapus (contoh: 1A, 2B):");
                        if (!kelas) return;
                        if (!allClasses.includes(kelas)) {
                            showNotification(`Kelas ${kelas} tidak ditemukan`, "error");
                            return;
                        }
                        confirmMessage = `âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA ABSENSI dari kelas ${kelas}.\n\nTindakan ini tidak dapat dibatalkan!`;
                        if (!confirm(confirmMessage)) return;
                        break;
                        
                    case 'student':
                        kelas = prompt("Masukkan kelas siswa:");
                        if (!kelas) return;
                        if (!allClasses.includes(kelas)) {
                            showNotification(`Kelas ${kelas} tidak ditemukan`, "error");
                            return;
                        }
                        studentId = prompt("Masukkan ID siswa:");
                        if (!studentId) return;
                        confirmMessage = `âš ï¸ APAKAH ANDA YAKIN?\n\nAnda akan menghapus SEMUA DATA ABSENSI untuk siswa ${studentId} di kelas ${kelas}.\n\nTindakan ini tidak dapat dibatalkan!`;
                        if (!confirm(confirmMessage)) return;
                        break;
                }
                
                showNotification("Menghapus data absensi...", "info");
                
                // Use firebaseApp function if available
                if (window.firebaseApp && window.firebaseApp.deleteAllAttendance) {
                    const result = await window.firebaseApp.deleteAllAttendance({
                        kelas: scope === 'all' ? null : kelas,
                        studentId: scope === 'student' ? studentId : null,
                        confirmation: false // Already confirmed
                    });
                    
                    if (result.success) {
                        showNotification(result.message, "success");
                    } else {
                        showNotification(result.message, "error");
                    }
                } else {
                    // Manual deletion
                    let path = 'attendance';
                    if (kelas) {
                        path = `attendance/${kelas}`;
                        if (studentId) {
                            path = `attendance/${kelas}/*/${studentId}`;
                        }
                    }
                    
                    await database.ref(path).remove();
                    
                    const successMessage = scope === 'all' 
                        ? "Semua data absensi berhasil dihapus"
                        : scope === 'class'
                            ? `Data absensi kelas ${kelas} berhasil dihapus`
                            : `Data absensi siswa ${studentId} berhasil dihapus`;
                    
                    showNotification(successMessage, "success");
                }
                
                // Refresh data
                await loadInitialData();
                
            } catch (error) {
                console.error("Error deleting attendance:", error);
                showNotification("Gagal menghapus data absensi: " + error.message, "error");
            }
        }

        // Fungsi untuk menghapus semua data
        async function deleteAllData() {
            const confirmMessage = "ðŸš¨ðŸš¨ðŸš¨ PERINGATAN TINGGI ðŸš¨ðŸš¨ðŸš¨\n\n" +
                "Anda akan menghapus SEMUA DATA dari sistem:\n" +
                "âœ“ Semua data siswa\n" +
                "âœ“ Semua data absensi\n" +
                "âœ“ Semua data nilai\n" +
                "âœ“ Semua data lainnya\n\n" +
                "Tindakan ini TIDAK DAPAT DIBATALKAN dan akan menghapus semua data secara permanen!\n\n" +
                "Ketik 'HAPUS SEMUA' untuk konfirmasi:";
            
            const userInput = prompt(confirmMessage);
            if (userInput !== 'HAPUS SEMUA') {
                showNotification("Penghapusan dibatalkan", "info");
                return;
            }
            
            try {
                showNotification("Mulai menghapus semua data...", "info");
                
                // Delete all data
                await database.ref().remove();
                
                showNotification("âœ… Semua data berhasil dihapus", "success");
                
                // Reload page after 3 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } catch (error) {
                console.error("Error deleting all data:", error);
                showNotification("Gagal menghapus semua data: " + error.message, "error");
            }
        }

        // ============================================
        // DOWNLOAD FUNCTIONS (sama seperti sebelumnya)
        // ============================================
        // [Kode download functions tetap sama seperti sebelumnya...]

        // ============================================
        // DATA VIEW FUNCTIONS (sama seperti sebelumnya)
        // ============================================
        // [Kode view functions tetap sama seperti sebelumnya...]

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showNotification(message, type = 'info') {
            if (window.firebaseApp && window.firebaseApp.showNotification) {
                window.firebaseApp.showNotification(message, type);
            } else {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    max-width: 400px;
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        function logout() {
            if (window.firebaseApp && window.firebaseApp.logout) {
                window.firebaseApp.logout();
            } else {
                if (confirm('Apakah Anda yakin ingin logout?')) {
                    auth.signOut().then(() => {
                        localStorage.clear();
                        window.location.href = 'index.html?v=' + new Date().getTime();
                    }).catch(error => {
                        console.error('Logout error:', error);
                        showNotification('Gagal logout', 'error');
                    });
                }
            }
        }

        // ============================================
        // EXPOSE FUNCTIONS TO GLOBAL SCOPE
        // ============================================
        window.addStudent = addStudent;
        window.deleteStudent = deleteStudent;
        window.clearStudentForm = clearStudentForm;
        window.refreshStudentList = refreshStudentList;
        window.showTab = showTab;
        window.logout = logout;
        
        // Admin Tools functions
        window.openEditModal = openEditModal;
        window.loadStudentForEdit = loadStudentForEdit;
        window.saveStudentEdit = saveStudentEdit;
        window.closeEditModal = closeEditModal;
        window.deleteScores = deleteScores;
        window.deleteAttendance = deleteAttendance;
        window.deleteAllData = deleteAllData;

        // Download functions
        window.downloadStudentsExcel = downloadStudentsExcel;
        window.downloadStudentsPDF = downloadStudentsPDF;
        window.downloadAttendanceByClassExcel = downloadAttendanceByClassExcel;
        window.downloadAttendanceByClassPDF = downloadAttendanceByClassPDF;
        window.downloadScoresByClassExcel = downloadScoresByClassExcel;
        window.downloadScoresByClassPDF = downloadScoresByClassPDF;
        window.downloadCompleteReportByClassExcel = downloadCompleteReportByClassExcel;
        window.downloadCompleteReportByClassPDF = downloadCompleteReportByClassPDF;
        window.downloadAttendanceExcel = downloadAttendanceExcel;
        window.downloadAttendancePDF = downloadAttendancePDF;
        window.downloadScoresExcel = downloadScoresExcel;
        window.downloadScoresPDF = downloadScoresPDF;
        window.downloadCompleteReportExcel = downloadCompleteReportExcel;
        window.downloadCompleteReportPDF = downloadCompleteReportPDF;
        window.downloadStatisticsExcel = downloadStatisticsExcel;
        window.downloadStatisticsPDF = downloadStatisticsPDF;
        window.loadAttendanceData = loadAttendanceData;
        window.loadScoresData = loadScoresData;
        window.initializeAdminSystem = initializeAdminSystem;
    </script>
</body>
</html>