<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi - SDN RAWABUNTU 03</title>
    <link rel="stylesheet" href="style.css">
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Custom styles for attendance page */
        .controls-wrapper {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .controls-wrapper {
                grid-template-columns: 1fr;
            }
        }
        
        .control-group {
            margin-bottom: 0;
        }
        
        .control-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }
        
        /* QR Code Scanner Styles */
        .qr-scanner-wrapper {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #3498db;
        }
        
        .qr-scanner-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        #qr-reader {
            width: 100%;
            height: 250px;
            background: #000;
        }
        
        .qr-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .manual-input-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Table Improvements - COMPACT LAYOUT */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }
        
        .data-table th {
            background: #f1f5f9;
            padding: 6px 3px !important;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table td {
            padding: 6px 3px !important;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        /* COLUMN WIDTHS - COMPACT */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 25px !important;
            min-width: 25px !important;
            max-width: 25px !important;
            text-align: center;
            padding: 4px 2px !important;
        }
        
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 50px !important;
            min-width: 50px !important;
            max-width: 50px !important;
            text-align: center;
            padding: 4px 2px !important;
        }
        
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: auto !important;
            min-width: 120px !important;
            padding-left: 5px !important;
            padding-right: 5px !important;
        }
        
        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            width: 110px !important;
            min-width: 110px !important;
            max-width: 110px !important;
            text-align: center;
            padding: 4px 2px !important;
        }
        
        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            text-align: center;
            padding: 4px 2px !important;
        }
        
        /* Attendance Buttons */
        .attendance-buttons {
            display: flex;
            gap: 2px;
            justify-content: center;
            width: 100%;
        }
        
        .att-btn {
            padding: 3px 4px !important;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 22px !important;
            height: 24px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .att-btn:hover {
            transform: translateY(-1px);
        }
        
        .att-btn.active {
            box-shadow: 0 0 0 1px currentColor;
            transform: scale(1.05);
        }
        
        .att-btn.hadir {
            background: #28a745;
            color: white;
        }
        
        .att-btn.ijin {
            background: #17a2b8;
            color: white;
        }
        
        .att-btn.sakit {
            background: #ffc107;
            color: #000;
        }
        
        .att-btn.alpa {
            background: #dc3545;
            color: white;
        }
        
        .time-cell {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
            white-space: nowrap;
        }
        
        .student-id-badge {
            background: #e2e8f0;
            color: #475569;
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        /* Summary Card */
        .summary-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border: 1px solid #e9ecef;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            text-align: center;
        }
        
        .summary-item {
            padding: 6px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .summary-count {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .summary-label {
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
        }
        
        @media (min-width: 480px) {
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .action-btn {
            padding: 10px 6px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 767px) {
            .data-table th:nth-child(5),
            .data-table td:nth-child(5) {
                display: none;
            }
            
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                width: 100px !important;
                min-width: 100px !important;
                max-width: 100px !important;
            }
            
            .att-btn {
                min-width: 20px !important;
                height: 22px !important;
                font-size: 0.7rem;
                padding: 2px 3px !important;
            }
        }
        
        @media (max-width: 480px) {
            .data-table th:nth-child(2),
            .data-table td:nth-child(2) {
                display: none;
            }
            
            .data-table th:nth-child(1),
            .data-table td:nth-child(1) {
                width: 20px !important;
                min-width: 20px !important;
                max-width: 20px !important;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-table th:nth-child(3),
            .data-table td:nth-child(3) {
                min-width: 100px !important;
                max-width: 100px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                width: 90px !important;
                min-width: 90px !important;
                max-width: 90px !important;
            }
            
            .att-btn {
                min-width: 18px !important;
                height: 20px !important;
                font-size: 0.65rem;
                padding: 1px 2px !important;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            margin: 15px 0;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content {
            display: block;
        }
        
        .save-btn {
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .save-btn:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 30px 20px;
            color: #64748b;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 60px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .notification.success {
            background: #28a745;
            color: white;
        }
        
        .notification.error {
            background: #dc3545;
            color: white;
        }
        
        .notification.info {
            background: #3498db;
            color: white;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .name-input-container {
            position: relative;
        }
        
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .student-name-cell {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Auto-detect button */
        .auto-detect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .auto-detect-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">
            SDN RAWABUNTU 03
            <span style="font-size: 11px; color: #7f8c8d;"> | Absensi Real-time</span>
        </div>
        <div class="navbar-user">
            <span id="userName" style="display: none;"></span>
            <button onclick="goBack()" class="btn" style="padding: 6px 10px; font-size: 0.8rem;">‚Üê</button>
            <button onclick="showTab('qr')" class="btn" style="padding: 6px 10px; font-size: 0.8rem; background: #3498db; color: white;">
                üì∑ QR
            </button>
            <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div style="padding: 20px 15px 15px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50; font-size: 1rem;">Menu Absensi</h3>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="absensi.html" class="active">üìù Absensi Manual</a></li>
                <li><a href="#" onclick="showTab('qr')">üì∑ QR Scan</a></li>
                <li><a href="monitoring.html">üëÅÔ∏è Monitoring</a></li>
                <li><a href="#" onclick="exportAttendance()">üì§ Export</a></li>
                <li><a href="#" onclick="logout()" style="color: #e74c3c;">üö™ Logout</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Tabs for Attendance Methods -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('manual')">Manual</div>
            <div class="tab" onclick="showTab('qr')">QR Code</div>
        </div>

        <!-- Manual Attendance Tab -->
        <div id="manualTab" class="tab-content">
            <!-- Controls Section -->
            <div class="controls-wrapper">
                <div class="control-group">
                    <label class="control-label">Kelas</label>
                    <select id="classSelect" class="form-control" onchange="loadStudents()">
                        <option value="">Pilih Kelas</option>
                    </select>
                    <button onclick="autoDetectClasses()" class="auto-detect-btn">
                        üîç Deteksi Otomatis
                    </button>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Tanggal</label>
                    <input type="date" id="attendanceDate" class="form-control" value="">
                    <button onclick="setToday()" class="auto-detect-btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üìÖ Hari Ini
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button onclick="markAll('hadir')" class="action-btn" style="background: #28a745; color: white;">
                    ‚úì Semua Hadir
                </button>
                <button onclick="markAll('ijin')" class="action-btn" style="background: #17a2b8; color: white;">
                    ‚ìò Semua Ijin
                </button>
                <button onclick="markAll('sakit')" class="action-btn" style="background: #ffc107; color: #000;">
                    ‚ûï Semua Sakit
                </button>
                <button onclick="markAll('alfa')" class="action-btn" style="background: #dc3545; color: white;">
                    ‚úó Semua Alfa
                </button>
            </div>

            <!-- Search Input -->
            <div class="search-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="Cari nama siswa..." 
                       oninput="filterStudents()">
            </div>

            <!-- Attendance Summary -->
            <div class="summary-card" id="summaryCard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 600; font-size: 0.9rem;">üìä REKAP ABSENSI</div>
                    <button onclick="saveAll()" class="save-btn">
                        üíæ SIMPAN SEMUA
                    </button>
                </div>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <!-- Students Table -->
            <div class="card" style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 class="card-title" style="margin: 0; font-size: 1rem;">üìã DAFTAR SISWA</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 16px; height: 16px;">
                        <label for="selectAll" style="font-size: 0.8rem; color: #6c757d;">Pilih Semua</label>
                    </div>
                </div>
                
                <div class="table-container" style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Status Kehadiran</th>
                                <th>Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                    <div>Deteksi otomatis atau pilih kelas...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- QR Code Tab -->
        <div id="qrTab" class="tab-content" style="display: none;">
            <div class="qr-scanner-wrapper">
                <h3 style="text-align: center; margin-bottom: 15px; color: #3498db;">üì∑ ABSENSI QR CODE</h3>
                
                <div class="qr-scanner-container">
                    <div id="qr-reader"></div>
                </div>
                
                <div class="qr-controls">
                    <button onclick="startQRScanner()" class="btn btn-primary" id="startScannerBtn">
                        ‚ñ∂ Mulai Scan
                    </button>
                    <button onclick="stopQRScanner()" class="btn btn-secondary" id="stopScannerBtn" style="display: none;">
                        ‚è∏ Stop Scan
                    </button>
                </div>
                
                <div class="manual-input-section">
                    <h4 style="margin-bottom: 10px; text-align: center;">Atau Input Manual</h4>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="name-input-container" style="flex: 1;">
                            <input type="text" id="manualName" class="form-control" placeholder="Masukkan nama siswa">
                            <div class="suggestions-list" id="nameSuggestions"></div>
                        </div>
                        <button onclick="manualAttendance()" class="btn btn-success">
                            ‚úì Absen
                        </button>
                    </div>
                </div>
                
                <div id="qrResult" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Recent QR Attendance -->
            <div class="card" style="margin-top: 15px;">
                <h3 class="card-title">üïê ABSENSI TERBARU (QR)</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Status</th>
                                <th>Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="recentAttendance">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #94a3b8;">
                                    Belum ada absensi QR
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" style="padding: 15px; text-align: center; background: #f8f9fa; margin-top: 20px; font-size: 0.8rem; color: #7f8c8d;">
        <p style="margin: 0;">
            &copy; 2024 Rendi Rahadian, S. Pd. - Sistem Absensi Digital Real-time
            <br>
            <span style="font-size: 0.7rem;">Data tersinkronisasi secara real-time</span>
        </p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_0hKhrz0vC7X_9KRrXiTOnRGI9Pi6tBI",
            authDomain: "absensi-dan-penilaian-siswa.firebaseapp.com",
            databaseURL: "https://absensi-dan-penilaian-siswa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensi-dan-penilaian-siswa",
            storageBucket: "absensi-dan-penilaian-siswa.firebasestorage.app",
            messagingSenderId: "774655798848",
            appId: "1:774655798848:web:d6ddb5a04d4acd91d1b9a5"
        };

        // Initialize Firebase
        let auth, database;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Global variables
        let currentClass = '';
        let currentDate = '';
        let studentsData = {};
        let filteredStudents = {};
        let html5QrCode = null;
        let nameSuggestions = [];
        let attendanceListener = null;

        // Check if user is logged in
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                document.getElementById('userName').textContent = localStorage.getItem('userName') || user.email;
                document.getElementById('userName').style.display = 'inline';
                initializePage();
            }
        });

        function initializePage() {
            console.log("üîÑ Initializing attendance page...");
            
            // Set today's date
            setToday();
            
            // Auto-detect classes
            autoDetectClasses();
            
            // Event listeners
            document.getElementById('attendanceDate').addEventListener('change', function(e) {
                currentDate = e.target.value;
                console.log("üìÖ Date changed to:", currentDate);
                if (currentClass) {
                    loadStudents();
                }
            });
            
            // Initialize QR Scanner
            html5QrCode = new Html5Qrcode("qr-reader");
            
            // Setup name input suggestions
            setupNameSuggestions();
            
            console.log("‚úÖ Attendance page initialized successfully");
        }

        function autoDetectClasses() {
            console.log("üîç Auto-detecting classes...");
            showNotification('üîç Mendeteksi struktur data...', 'info');
            
            // Clear existing options
            const classSelect = document.getElementById('classSelect');
            classSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            
            // Try to get classes from students structure
            database.ref('students').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    const foundClasses = [];
                    
                    if (data) {
                        // If data is structured as { "1A": { ... }, "1B": { ... } }
                        Object.keys(data).forEach(className => {
                            if (className && !foundClasses.includes(className)) {
                                foundClasses.push(className);
                            }
                        });
                    }
                    
                    if (foundClasses.length > 0) {
                        foundClasses.sort().forEach(className => {
                            const option = document.createElement('option');
                            option.value = className;
                            option.textContent = `Kelas ${className}`;
                            classSelect.appendChild(option);
                        });
                        
                        // Try to load from URL parameter or localStorage
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlClass = urlParams.get('class');
                        const savedClass = localStorage.getItem('lastSelectedClass');
                        
                        if (urlClass && foundClasses.includes(urlClass)) {
                            classSelect.value = urlClass;
                        } else if (savedClass && foundClasses.includes(savedClass)) {
                            classSelect.value = savedClass;
                        } else if (foundClasses.length > 0) {
                            classSelect.value = foundClasses[0];
                        }
                        
                        if (classSelect.value) {
                            console.log("üè´ Auto-selected class:", classSelect.value);
                            loadStudents();
                        }
                        
                        showNotification(`‚úÖ Ditemukan ${foundClasses.length} kelas`, 'success');
                    } else {
                        // If no classes found, check if sample data exists
                        database.ref('students/1A').once('value')
                            .then((classSnapshot) => {
                                if (!classSnapshot.exists()) {
                                    showNotification('‚ùå Tidak ditemukan data kelas. Buat data contoh dulu di halaman penilaian.', 'error');
                                }
                            });
                    }
                })
                .catch((error) => {
                    console.error("Error detecting classes:", error);
                    showNotification('‚ùå Gagal mendeteksi kelas', 'error');
                });
        }

        function setupNameSuggestions() {
            const nameInput = document.getElementById('manualName');
            const suggestionsDiv = document.getElementById('nameSuggestions');
            
            nameInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (query.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // Filter students based on query
                nameSuggestions = [];
                if (studentsData && Object.keys(studentsData).length > 0) {
                    Object.entries(studentsData).forEach(([studentId, student]) => {
                        const studentName = student.nama || student.name || '';
                        if (studentName.toLowerCase().includes(query)) {
                            nameSuggestions.push({ 
                                studentId, 
                                name: studentName,
                                kelas: currentClass 
                            });
                        }
                    });
                }
                
                // Display suggestions
                if (nameSuggestions.length > 0) {
                    suggestionsDiv.innerHTML = '';
                    nameSuggestions.slice(0, 5).forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = `${item.name} (${item.kelas})`;
                        div.onclick = function() {
                            nameInput.value = item.name;
                            suggestionsDiv.style.display = 'none';
                            
                            // Create QR data
                            const qrData = JSON.stringify({
                                studentId: item.studentId,
                                kelas: item.kelas
                            });
                            processQRResult(qrData);
                        };
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!nameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        function loadStudents() {
            currentClass = document.getElementById('classSelect').value;
            if (!currentClass) {
                document.getElementById('studentsTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="loading">
                            <div>Silahkan pilih kelas terlebih dahulu</div>
                        </td>
                    </tr>
                `;
                document.getElementById('summaryCard').style.display = 'none';
                return;
            }

            console.log("üë• Loading students for class:", currentClass);
            
            // Save last selected class
            localStorage.setItem('lastSelectedClass', currentClass);

            const studentsTable = document.getElementById('studentsTable');
            studentsTable.innerHTML = `
                <tr>
                    <td colspan="5" class="loading">
                        <div class="spinner"></div>
                        <div>Memuat data siswa...</div>
                    </td>
                </tr>
            `;

            // Try to load students from the selected class
            const studentPath = `students/${currentClass}`;
            
            database.ref(studentPath).once('value')
                .then((snapshot) => {
                    const students = snapshot.val();
                    console.log("üìä Students data received:", students);
                    
                    if (!students) {
                        studentsTable.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; color: #dc3545; padding: 30px;">
                                    ‚ùå Tidak ada data siswa di kelas ${currentClass}
                                    <br>
                                    <small style="color: #6c757d;">Buat data siswa terlebih dahulu di halaman penilaian</small>
                                </td>
                            </tr>
                        `;
                        studentsData = {};
                        filteredStudents = {};
                        document.getElementById('summaryCard').style.display = 'none';
                        showNotification(`‚ùå Tidak ada data siswa di kelas ${currentClass}`, 'error');
                        return;
                    }
                    
                    studentsData = students;
                    filteredStudents = {...studentsData};
                    renderStudentsTable(students);
                    loadExistingAttendance();
                    updateAttendanceSummary();
                    showNotification(`‚úÖ Data siswa kelas ${currentClass} dimuat (${Object.keys(students).length} siswa)`, 'success');
                })
                .catch((error) => {
                    console.error("‚ùå Error loading students:", error);
                    studentsTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; color: #dc3545; padding: 30px;">
                                ‚ùå Gagal memuat data siswa: ${error.message}
                            </td>
                        </tr>
                    `;
                    document.getElementById('summaryCard').style.display = 'none';
                    showNotification('‚ùå Gagal memuat data siswa', 'error');
                });
        }

        function renderStudentsTable(students) {
            const studentsTable = document.getElementById('studentsTable');
            studentsTable.innerHTML = '';

            if (!students || Object.keys(students).length === 0) {
                studentsTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="loading">
                            <div>‚ùå Tidak ada data siswa di kelas ini</div>
                        </td>
                    </tr>
                `;
                return;
            }

            let index = 1;
            Object.keys(students).forEach(studentId => {
                const student = students[studentId];
                const studentName = student.nama || student.name || 'Tanpa Nama';
                const studentKelas = student.kelas || currentClass;
                
                const row = document.createElement('tr');
                row.id = `row-${studentId}`;
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="student-checkbox" value="${studentId}" style="width: 16px; height: 16px;">
                    </td>
                    <td>
                        <span class="student-id-badge">${index}</span>
                    </td>
                    <td class="student-name-cell" title="${studentName}">
                        ${studentName}
                        <div style="font-size: 0.7rem; color: #94a3b8;">
                            ${studentKelas}
                        </div>
                    </td>
                    <td>
                        <div class="attendance-buttons" data-studentid="${studentId}">
                            <button class="att-btn hadir" onclick="setAttendance('${studentId}', 'hadir')" title="Hadir">H</button>
                            <button class="att-btn ijin" onclick="setAttendance('${studentId}', 'ijin')" title="Ijin">I</button>
                            <button class="att-btn sakit" onclick="setAttendance('${studentId}', 'sakit')" title="Sakit">S</button>
                            <button class="att-btn alpa" onclick="setAttendance('${studentId}', 'alfa')" title="Alfa">A</button>
                        </div>
                    </td>
                    <td class="time-cell" id="time-${studentId}">-</td>
                `;
                
                studentsTable.appendChild(row);
                index++;
            });
        }

        function setupRealtimeListener() {
            // Remove existing listener if any
            if (attendanceListener && typeof attendanceListener === 'function') {
                try {
                    database.ref(`attendance/${currentClass}/${currentDate}`).off('value', attendanceListener);
                } catch (e) {
                    console.log("No existing listener to remove");
                }
            }
            
            // Setup new listener only if we have both class and date
            if (currentClass && currentDate) {
                console.log("üëÇ Setting up realtime listener for:", currentClass, currentDate);
                
                attendanceListener = (snapshot) => {
                    const attendance = snapshot.val();
                    console.log("üì° Realtime update received:", attendance);
                    
                    if (attendance) {
                        Object.keys(attendance).forEach(studentId => {
                            const record = attendance[studentId];
                            const status = record.status || 'hadir';
                            const time = record.time || '-';
                            
                            // Update button appearance
                            updateAttendanceUI(studentId, status, time);
                        });
                    } else {
                        console.log("üì≠ No attendance data yet for this date");
                    }
                    updateAttendanceSummary();
                };
                
                // Attach the listener
                database.ref(`attendance/${currentClass}/${currentDate}`).on('value', attendanceListener);
            } else {
                console.log("‚ö†Ô∏è Cannot setup listener: missing class or date");
            }
        }

        function updateAttendanceUI(studentId, status, time) {
            // Update button appearance
            const buttons = document.querySelectorAll(`[data-studentid="${studentId}"] .att-btn`);
            if (buttons.length > 0) {
                buttons.forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`[data-studentid="${studentId}"] .att-btn.${status === 'alfa' ? 'alpa' : status}`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                // Update time
                const timeCell = document.getElementById(`time-${studentId}`);
                if (timeCell) {
                    timeCell.textContent = time;
                }
            }
        }

        function setAttendance(studentId, status) {
            if (!currentClass || !currentDate) {
                showNotification('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }

            console.log("üìù Setting attendance:", studentId, status);
            
            // Update UI immediately for better UX
            updateAttendanceUI(studentId, status, new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }));
            
            // Get student name
            const student = studentsData[studentId];
            const studentName = student ? (student.nama || student.name || 'Tanpa Nama') : 'Unknown';
            
            // Prepare data
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const attendanceData = {
                status: status,
                time: time,
                teacher: localStorage.getItem('userEmail') || auth.currentUser?.email,
                updatedAt: new Date().toISOString(),
                method: 'manual',
                studentName: studentName,
                kelas: currentClass
            };
            
            // Save to Firebase
            database.ref(`attendance/${currentClass}/${currentDate}/${studentId}`).set(attendanceData)
            .then(() => {
                console.log("üíæ Attendance saved successfully");
                showNotification(`‚úÖ ${studentName} - ${status.toUpperCase()}`, 'success');
                updateAttendanceSummary();
            })
            .catch((error) => {
                console.error('‚ùå Error saving attendance:', error);
                showNotification('‚ùå Gagal menyimpan absensi', 'error');
            });
        }

        function loadExistingAttendance() {
            if (!currentClass || !currentDate) {
                console.log("‚ö†Ô∏è Cannot load attendance: missing class or date");
                return;
            }

            console.log("üìã Loading existing attendance for:", currentClass, currentDate);
            
            // Setup realtime listener first
            setupRealtimeListener();
            
            // Then load initial data
            database.ref(`attendance/${currentClass}/${currentDate}`).once('value')
                .then((snapshot) => {
                    const attendance = snapshot.val();
                    if (attendance) {
                        console.log("‚úÖ Found existing attendance data:", Object.keys(attendance).length, "records");
                        Object.keys(attendance).forEach(studentId => {
                            const record = attendance[studentId];
                            const status = record.status || 'hadir';
                            const time = record.time || '-';
                            
                            updateAttendanceUI(studentId, status, time);
                        });
                    } else {
                        console.log("üì≠ No existing attendance data");
                    }
                    updateAttendanceSummary();
                })
                .catch((error) => {
                    console.error("‚ùå Error loading existing attendance:", error);
                });
        }

        function saveAll() {
            if (!currentClass || !currentDate) {
                showNotification('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }

            // All attendance is already saved in real-time
            showNotification('‚úÖ Semua absensi sudah disimpan secara real-time', 'success');
            updateAttendanceSummary();
        }

        function markAll(status) {
            if (!currentClass || !currentDate) {
                showNotification('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }

            console.log("üéØ Marking all students as:", status);
            
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const teacher = localStorage.getItem('userEmail') || auth.currentUser?.email;
            
            const promises = [];
            
            Object.keys(filteredStudents).forEach(studentId => {
                const student = filteredStudents[studentId];
                const studentName = student ? (student.nama || student.name || 'Tanpa Nama') : 'Unknown';
                
                const attendanceData = {
                    status: status,
                    time: time,
                    teacher: teacher,
                    updatedAt: new Date().toISOString(),
                    method: 'manual_bulk',
                    studentName: studentName,
                    kelas: currentClass
                };
                
                // Update UI immediately
                updateAttendanceUI(studentId, status, time);
                
                // Save to Firebase
                const promise = database.ref(`attendance/${currentClass}/${currentDate}/${studentId}`).set(attendanceData);
                promises.push(promise);
            });
            
            // Wait for all saves to complete
            Promise.all(promises)
                .then(() => {
                    showNotification(`‚úÖ ${Object.keys(filteredStudents).length} siswa ditandai sebagai ${status}`, 'success');
                    updateAttendanceSummary();
                })
                .catch((error) => {
                    console.error('‚ùå Error marking all students:', error);
                    showNotification('‚ùå Gagal menyimpan beberapa absensi', 'error');
                });
        }

        function markSelected(status) {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('Pilih siswa terlebih dahulu!', 'error');
                return;
            }

            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const teacher = localStorage.getItem('userEmail') || auth.currentUser?.email;
            
            const promises = [];
            
            checkboxes.forEach(checkbox => {
                const studentId = checkbox.value;
                const student = studentsData[studentId];
                const studentName = student ? (student.nama || student.name || 'Tanpa Nama') : 'Unknown';
                
                const attendanceData = {
                    status: status,
                    time: time,
                    teacher: teacher,
                    updatedAt: new Date().toISOString(),
                    method: 'manual_selected',
                    studentName: studentName,
                    kelas: currentClass
                };
                
                // Update UI immediately
                updateAttendanceUI(studentId, status, time);
                
                // Save to Firebase
                const promise = database.ref(`attendance/${currentClass}/${currentDate}/${studentId}`).set(attendanceData);
                promises.push(promise);
            });
            
            // Wait for all saves to complete
            Promise.all(promises)
                .then(() => {
                    showNotification(`‚úÖ ${checkboxes.length} siswa ditandai sebagai ${status}`, 'success');
                    updateAttendanceSummary();
                })
                .catch((error) => {
                    console.error('‚ùå Error marking selected students:', error);
                    showNotification('‚ùå Gagal menyimpan beberapa absensi', 'error');
                });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function updateAttendanceSummary() {
            if (!currentClass || !studentsData || Object.keys(studentsData).length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                return;
            }

            const statusCounts = { hadir: 0, ijin: 0, sakit: 0, alfa: 0 };
            let sudah = 0;
            const total = Object.keys(filteredStudents).length;
            
            // Count from current display
            Object.keys(filteredStudents).forEach(studentId => {
                const activeBtn = document.querySelector(`[data-studentid="${studentId}"] .att-btn.active`);
                if (activeBtn) {
                    sudah++;
                    if (activeBtn.classList.contains('hadir')) statusCounts.hadir++;
                    else if (activeBtn.classList.contains('ijin')) statusCounts.ijin++;
                    else if (activeBtn.classList.contains('sakit')) statusCounts.sakit++;
                    else if (activeBtn.classList.contains('alpa')) statusCounts.alfa++;
                }
            });
            
            const belum = total - sudah;
            
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-count" style="color: #28a745;">${statusCounts.hadir}</div>
                    <div class="summary-label">Hadir</div>
                </div>
                <div class="summary-item">
                    <div class="summary-count" style="color: #17a2b8;">${statusCounts.ijin}</div>
                    <div class="summary-label">Ijin</div>
                </div>
                <div class="summary-item">
                    <div class="summary-count" style="color: #ffc107;">${statusCounts.sakit}</div>
                    <div class="summary-label">Sakit</div>
                </div>
                <div class="summary-item">
                    <div class="summary-count" style="color: #dc3545;">${statusCounts.alfa}</div>
                    <div class="summary-label">Alfa</div>
                </div>
                <div class="summary-item">
                    <div class="summary-count" style="color: #6c757d;">${belum}</div>
                    <div class="summary-label">Belum</div>
                </div>
            `;
            
            document.getElementById('summaryCard').style.display = 'block';
        }

        // QR Code Functions
        function startQRScanner() {
            if (!currentClass) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            console.log("üì∑ Starting QR Scanner...");
            
            const qrSuccessCallback = (decodedText) => {
                console.log("QR Code detected:", decodedText);
                processQRResult(decodedText);
            };
            
            const config = { 
                fps: 10, 
                qrbox: { width: 200, height: 200 }
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                qrSuccessCallback
            ).then(() => {
                document.getElementById('startScannerBtn').style.display = 'none';
                document.getElementById('stopScannerBtn').style.display = 'inline-block';
                console.log("‚úÖ QR Scanner started");
            }).catch(err => {
                console.error("‚ùå Failed to start scanner:", err);
                showNotification("‚ùå Gagal memulai kamera. Izinkan akses kamera.", "error");
            });
        }

        function stopQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('startScannerBtn').style.display = 'inline-block';
                    document.getElementById('stopScannerBtn').style.display = 'none';
                    console.log("‚è∏ QR Scanner stopped");
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                });
            }
        }

        function processQRResult(qrData) {
            console.log("üîç Processing QR result:", qrData);
            
            try {
                let studentId, kelas;
                
                // Try to parse as JSON
                try {
                    const data = JSON.parse(qrData);
                    studentId = data.studentId || data.id || data.siswa;
                    kelas = data.kelas || data.class || currentClass;
                } catch (e) {
                    // If not JSON, assume it's just studentId
                    studentId = qrData.trim();
                    kelas = currentClass;
                }
                
                if (!studentId) {
                    showNotification("‚ùå QR Code tidak valid", "error");
                    return;
                }
                
                markAttendanceFromQR(studentId, kelas, 'hadir');
                
            } catch (error) {
                console.error("‚ùå Error processing QR:", error);
                showNotification("‚ùå QR Code tidak valid", "error");
            }
        }

        function markAttendanceFromQR(studentId, kelas, status) {
            // Use specified kelas or current class
            const targetKelas = kelas || currentClass;
            
            if (!targetKelas) {
                showNotification('‚ùå Kelas tidak ditemukan!', 'error');
                return;
            }

            console.log("üéØ Marking attendance from QR:", studentId, targetKelas);
            
            // Check if student exists (try to load from the class)
            database.ref(`students/${targetKelas}/${studentId}`).once('value')
                .then((snapshot) => {
                    const student = snapshot.val();
                    if (!student) {
                        showNotification(`‚ùå Siswa ${studentId} tidak ditemukan di kelas ${targetKelas}`, "error");
                        return;
                    }

                    const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    const studentName = student.nama || student.name || 'Tanpa Nama';
                    
                    const attendanceData = {
                        status: status,
                        time: time,
                        teacher: localStorage.getItem('userEmail') || auth.currentUser?.email,
                        updatedAt: new Date().toISOString(),
                        method: 'qr',
                        studentName: studentName,
                        kelas: targetKelas,
                        studentId: studentId
                    };
                    
                    // Save to Firebase
                    return database.ref(`attendance/${targetKelas}/${currentDate}/${studentId}`).set(attendanceData)
                        .then(() => {
                            console.log("‚úÖ QR attendance saved");
                            
                            const qrResult = document.getElementById('qrResult');
                            qrResult.innerHTML = `
                                <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                                    ‚úÖ <strong>${studentName}</strong> berhasil diabsen via QR
                                    <br>
                                    <small>${targetKelas} ‚Ä¢ ${time} ‚Ä¢ Status: ${status.toUpperCase()}</small>
                                </div>
                            `;
                            
                            showNotification(`‚úÖ QR Absensi: ${studentName} berhasil`, 'success');
                            updateRecentAttendance(studentId, studentName, targetKelas, status, time);
                            
                            // Update manual tab if visible and same class
                            if (targetKelas === currentClass && studentsData[studentId]) {
                                updateAttendanceUI(studentId, status, time);
                                updateAttendanceSummary();
                            }
                            
                            // Clear result after 2 seconds
                            setTimeout(() => {
                                document.getElementById('qrResult').innerHTML = '';
                            }, 2000);
                        });
                })
                .catch((error) => {
                    console.error('‚ùå Error saving QR attendance:', error);
                    showNotification('‚ùå Gagal menyimpan absensi QR', 'error');
                });
        }

        function manualAttendance() {
            const nameInput = document.getElementById('manualName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('‚ùå Masukkan nama siswa', 'error');
                return;
            }
            
            // Find student by name in current class
            let foundStudentId = null;
            let foundName = null;
            
            for (const [studentId, student] of Object.entries(studentsData)) {
                const studentName = student.nama || student.name || '';
                if (studentName.toLowerCase() === name.toLowerCase() || 
                    studentName.toLowerCase().includes(name.toLowerCase())) {
                    foundStudentId = studentId;
                    foundName = studentName;
                    break;
                }
            }
            
            if (!foundStudentId) {
                showNotification('‚ùå Siswa tidak ditemukan di kelas ini', 'error');
                return;
            }
            
            markAttendanceFromQR(foundStudentId, currentClass, 'hadir');
            nameInput.value = '';
            document.getElementById('nameSuggestions').style.display = 'none';
        }

        function updateRecentAttendance(studentId, name, kelas, status, time) {
            const recentTable = document.getElementById('recentAttendance');
            const firstRow = recentTable.querySelector('tr');
            
            if (firstRow && firstRow.cells[0].textContent === 'Belum ada absensi QR') {
                recentTable.innerHTML = '';
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>1</td>
                <td>${name}</td>
                <td>${kelas}</td>
                <td>
                    <span style="color: ${status === 'hadir' ? '#28a745' : status === 'ijin' ? '#17a2b8' : status === 'sakit' ? '#ffc107' : '#dc3545'}; font-weight: bold;">
                        ${status.toUpperCase()}
                    </span>
                </td>
                <td>${time}</td>
            `;
            
            recentTable.insertBefore(row, recentTable.firstChild);
            
            // Limit to 10 rows
            const rows = recentTable.querySelectorAll('tr');
            if (rows.length > 10) {
                recentTable.removeChild(rows[rows.length - 1]);
            }
            
            // Update numbers
            rows.forEach((row, index) => {
                if (row.cells[0]) {
                    row.cells[0].textContent = index + 1;
                }
            });
        }

        function showTab(tabName) {
            console.log("üìë Switching to tab:", tabName);
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            if (tabName === 'manual') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('manualTab').style.display = 'block';
                stopQRScanner();
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('qrTab').style.display = 'block';
                if (currentClass) {
                    setTimeout(() => startQRScanner(), 500);
                }
            }
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredStudents = {...studentsData};
                renderStudentsTable(filteredStudents);
                loadExistingAttendance();
                return;
            }
            
            filteredStudents = {};
            Object.keys(studentsData).forEach(studentId => {
                const student = studentsData[studentId];
                const studentName = student.nama || student.name || '';
                if (studentName.toLowerCase().includes(searchTerm)) {
                    filteredStudents[studentId] = student;
                }
            });
            
            renderStudentsTable(filteredStudents);
            loadExistingAttendance();
        }

        function showNotification(message, type = 'success') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }

        function setToday() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            currentDate = formattedDate;
            document.getElementById('attendanceDate').value = formattedDate;
            console.log("üìÖ Set date to today:", formattedDate);
            
            if (currentClass) {
                loadStudents();
            }
        }

        function goBack() {
            window.history.back();
        }

        function exportAttendance() {
            if (!currentClass || !currentDate) {
                showNotification('‚ùå Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }
            
            console.log("üì§ Exporting attendance for:", currentClass, currentDate);
            
            // Create CSV data
            let csv = 'No,ID Siswa,Nama,Kelas,Status,Waktu\n';
            
            let index = 1;
            Object.keys(studentsData).forEach(studentId => {
                const student = studentsData[studentId];
                const studentName = student.nama || student.name || '';
                const studentKelas = student.kelas || currentClass;
                const activeBtn = document.querySelector(`[data-studentid="${studentId}"] .att-btn.active`);
                const timeCell = document.getElementById(`time-${studentId}`);
                
                let status = 'Belum';
                if (activeBtn) {
                    if (activeBtn.classList.contains('hadir')) status = 'Hadir';
                    else if (activeBtn.classList.contains('ijin')) status = 'Ijin';
                    else if (activeBtn.classList.contains('sakit')) status = 'Sakit';
                    else if (activeBtn.classList.contains('alpa')) status = 'Alfa';
                }
                
                const time = timeCell ? timeCell.textContent : '-';
                
                csv += `${index++},"${studentId}","${studentName}",${studentKelas},${status},${time}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Absensi_${currentClass}_${currentDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('‚úÖ File CSV berhasil diunduh!', 'success');
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                console.log("üö™ Logging out...");
                stopQRScanner();
                
                // Remove attendance listener
                if (attendanceListener && currentClass && currentDate) {
                    database.ref(`attendance/${currentClass}/${currentDate}`).off('value', attendanceListener);
                }
                
                auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.href = 'index.html';
                });
            }
        }

        // Make functions available globally
        window.loadStudents = loadStudents;
        window.filterStudents = filterStudents;
        window.setAttendance = setAttendance;
        window.saveAll = saveAll;
        window.markAll = markAll;
        window.markSelected = markSelected;
        window.toggleSelectAll = toggleSelectAll;
        window.updateAttendanceSummary = updateAttendanceSummary;
        window.toggleSidebar = toggleSidebar;
        window.goBack = goBack;
        window.exportAttendance = exportAttendance;
        window.logout = logout;
        window.showTab = showTab;
        window.startQRScanner = startQRScanner;
        window.stopQRScanner = stopQRScanner;
        window.manualAttendance = manualAttendance;
        window.autoDetectClasses = autoDetectClasses;
        window.setToday = setToday;
        window.processQRResult = processQRResult;
        
        console.log("üéâ Attendance page fully loaded with sorting features!");
    </script>
</body>
</html>