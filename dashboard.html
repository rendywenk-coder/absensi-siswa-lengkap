
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- CACHE CONTROL META TAGS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SDN RAWABUNTU 03</title>
    <link rel="stylesheet" href="style.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Dashboard specific styles */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .welcome-text {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .role-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #eef2f7;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-card.blue i { color: #3498db; }
        .stat-card.green i { color: #2ecc71; }
        .stat-card.orange i { color: #e67e22; }
        .stat-card.purple i { color: #9b59b6; }
        
        .stat-card.blue { border-top: 4px solid #3498db; }
        .stat-card.green { border-top: 4px solid #2ecc71; }
        .stat-card.orange { border-top: 4px solid #e67e22; }
        .stat-card.purple { border-top: 4px solid #9b59b6; }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            border: 2px solid #eef2f7;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
        }
        
        .action-btn:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(52, 152, 219, 0.1);
        }
        
        .action-btn i {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            color: white;
        }
        
        .action-btn.absensi i { background: #3498db; }
        .action-btn.penilaian i { background: #2ecc71; }
        .action-btn.monitoring i { background: #9b59b6; }
        .action-btn.laporan i { background: #e74c3c; }
        
        .action-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .action-text p {
            margin: 0;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
            border: 1px solid #eef2f7;
        }
        
        .recent-activity h2 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.3s;
        }
        
        .activity-item:hover {
            background: #f9f9f9;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .activity-icon.absensi { background: #3498db; }
        .activity-icon.penilaian { background: #2ecc71; }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: #2c3e50;
        }
        
        .activity-desc {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: #95a5a6;
        }
        
        .no-activity {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        
        .no-activity i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ecf0f1;
        }
        
        .loading-activity {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .classes-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .class-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .export-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .export-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .export-content p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .export-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Cache Control Button */
        .cache-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .cache-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .cache-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .export-section {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .cache-control {
                bottom: 10px;
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                padding: 20px 15px;
            }
            
            .welcome-text {
                font-size: 1.2rem;
            }
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eef2f7;
            color: #95a5a6;
            font-size: 0.85rem;
        }
        
        /* Custom Cache Warning */
        .cache-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">
            SDN RAWABUNTU 03
            <span style="font-size: 11px; color: #7f8c8d;"> | Dashboard</span>
        </div>
        <div class="navbar-user">
            <span id="userName"></span>
            <button onclick="clearCache()" class="btn btn-warning" style="padding: 6px 12px; font-size: 0.85rem; margin-right: 10px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button onclick="logout()" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Cache Warning -->
    <div class="cache-warning" id="cacheWarning">
        <i class="fas fa-exclamation-triangle"></i> Cache diperbarui. Halaman akan direfresh...
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="welcome-text" id="welcomeText">Selamat datang!</div>
            <p id="userInfo">Memuat informasi pengguna...</p>
            <div class="classes-badges" id="classesBadges">
                <!-- Kelas akses akan dimuat di sini -->
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <i class="fas fa-users"></i>
                <div class="stat-number" id="totalSiswa">0</div>
                <div class="stat-label">Total Siswa</div>
            </div>
            
            <div class="stat-card green">
                <i class="fas fa-calendar-check"></i>
                <div class="stat-number" id="absensiHariIni">0</div>
                <div class="stat-label">Absensi Hari Ini</div>
            </div>
            
            <div class="stat-card orange">
                <i class="fas fa-chart-bar"></i>
                <div class="stat-number" id="nilaiMasuk">0</div>
                <div class="stat-label">Nilai Masuk</div>
            </div>
            
            <div class="stat-card purple">
                <i class="fas fa-percentage"></i>
                <div class="stat-number" id="rataRataNilai">0</div>
                <div class="stat-label">Rata-rata Nilai</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="absensi.html?v=2" class="action-btn absensi">
                <i class="fas fa-clipboard-check"></i>
                <div class="action-text">
                    <h3>Absensi</h3>
                    <p>Input absensi harian siswa dengan QR Code atau manual</p>
                </div>
            </a>
            
            <a href="penilaian.html?v=2" class="action-btn penilaian">
                <i class="fas fa-graduation-cap"></i>
                <div class="action-text">
                    <h3>Penilaian</h3>
                    <p>Input nilai harian, sumatif, dan nilai akhir siswa</p>
                </div>
            </a>
            
            <a href="monitoring.html?v=2" class="action-btn monitoring">
                <i class="fas fa-chart-line"></i>
                <div class="action-text">
                    <h3>Monitoring</h3>
                    <p>Pantau statistik dan perkembangan siswa secara real-time</p>
                </div>
            </a>
            
            <a href="javascript:void(0)" onclick="exportLaporan()" class="action-btn laporan">
                <i class="fas fa-file-export"></i>
                <div class="action-text">
                    <h3>Export Laporan</h3>
                    <p>Download laporan dalam format Excel atau PDF</p>
                </div>
            </a>
        </div>
        
        <!-- Recent Activity -->
        <div class="recent-activity">
            <h2><i class="fas fa-history"></i> Aktivitas Terbaru</h2>
            <div class="activity-list" id="activityList">
                <div class="loading-activity">
                    <div class="loading-spinner"></div>
                    <p>Memuat aktivitas...</p>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <div class="export-content">
                <h3><i class="fas fa-download"></i> Export Laporan</h3>
                <p>Download laporan dalam format Excel atau PDF</p>
            </div>
            <button onclick="exportLaporan()" class="export-btn">
                <i class="fas fa-download"></i> Download Laporan
            </button>
        </div>
        
        <!-- Admin Access Button (Hidden for non-admin) -->
        <div id="adminAccess" style="display: none; margin-top: 20px;">
            <div class="export-section" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);">
                <div class="export-content">
                    <h3><i class="fas fa-user-shield"></i> Akses Administrator</h3>
                    <p>Akses halaman admin untuk manajemen data lengkap</p>
                </div>
                <button onclick="goToAdmin()" class="export-btn" style="color: #3498db;">
                    <i class="fas fa-cogs"></i> Buka Panel Admin
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="dashboard-footer">
            ¬© 2024 SDN Rawabuntu 03 - Sistem Absensi & Penilaian<br>
            <small>Versi: 2.0 | Terakhir diperbarui: <span id="lastUpdated"></span></small>
        </div>
    </div>

    <!-- Cache Control Button -->
    <div class="cache-control">
        <button class="cache-btn" onclick="clearCache()" title="Refresh Cache">
            <i class="fas fa-redo"></i>
        </button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // ============================================
        // KONFIGURASI FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD_0hKhrz0vC7X_9KRrXiTOnRGI9Pi6tBI",
            authDomain: "absensi-dan-penilaian-siswa.firebaseapp.com",
            databaseURL: "https://absensi-dan-penilaian-siswa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensi-dan-penilaian-siswa",
            storageBucket: "absensi-dan-penilaian-siswa.firebasestorage.app",
            messagingSenderId: "774655798848",
            appId: "1:774655798848:web:d6ddb5a04d4acd91d1b9a5"
        };

        // Inisialisasi Firebase
        let auth, database;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log("Firebase berhasil diinisialisasi di dashboard");
        } catch (error) {
            console.error("Error inisialisasi Firebase:", error);
        }

        // ============================================
        // VARIABEL GLOBAL
        // ============================================
        let userRole = '';
        let userEmail = '';
        let userClasses = [];
        let today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
        let appVersion = '2.0.0';

        // ============================================
        // INISIALISASI HALAMAN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üîÑ Dashboard initializing...");
            
            // Set last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Check cache version
            checkCacheVersion();
            
            // Cek status login
            auth.onAuthStateChanged((user) => {
                if (user) {
                    userEmail = user.email;
                    userRole = detectRoleFromEmail(userEmail);
                    console.log("Dashboard: User login:", userEmail, "Role:", userRole);
                    
                    document.getElementById('userName').textContent = user.email;
                    updateUserInfo();
                    loadUserClasses();
                    loadDashboardStats();
                    loadRecentActivities();
                    
                    // Check if admin and show admin access
                    checkAdminAccess();
                    
                    // Save login timestamp
                    localStorage.setItem('lastLogin', new Date().getTime());
                } else {
                    console.log("User not logged in, redirecting to login...");
                    window.location.href = 'index.html?v=' + new Date().getTime();
                }
            });
            
            // Auto refresh cache every 5 minutes
            setInterval(checkCacheVersion, 300000);
        });

        // ============================================
        // CACHE CONTROL FUNCTIONS
        // ============================================
        function checkCacheVersion() {
            const cachedVersion = localStorage.getItem('appVersion');
            const cacheTimestamp = localStorage.getItem('cacheTimestamp');
            const currentTime = new Date().getTime();
            
            // If no cache version or version mismatch
            if (!cachedVersion || cachedVersion !== appVersion) {
                console.log("üîÑ Cache version mismatch, clearing cache...");
                clearCache();
                return;
            }
            
            // If cache older than 30 minutes
            if (cacheTimestamp && (currentTime - parseInt(cacheTimestamp)) > 1800000) {
                console.log("üîÑ Cache expired (30 mins), refreshing...");
                showCacheWarning();
                setTimeout(clearCache, 2000);
            }
        }
        
        function showCacheWarning() {
            const warning = document.getElementById('cacheWarning');
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }
        
        function clearCache() {
            console.log("üßπ Clearing cache...");
            
            // Clear localStorage
            localStorage.removeItem('dashboardCache');
            localStorage.removeItem('userClassesCache');
            localStorage.removeItem('statsCache');
            localStorage.removeItem('activitiesCache');
            
            // Force refresh without cache
            window.location.reload(true);
            
            // Show notification
            showCacheWarning();
        }

        // ============================================
        // FUNGSI UTAMA DASHBOARD
        // ============================================

        // Deteksi role dari email
        function detectRoleFromEmail(email) {
            if (!email) return 'unknown';
            if (email === 'admin@rbt.com') return 'admin';
            if (email.includes('kelas')) return 'guru_kelas';
            if (email.includes('pjok')) return 'guru_pjok';
            return 'unknown';
        }

        // Check admin access
        function checkAdminAccess() {
            const adminAccessDiv = document.getElementById('adminAccess');
            if (userEmail === 'admin@rbt.com') {
                adminAccessDiv.style.display = 'block';
            } else {
                adminAccessDiv.style.display = 'none';
            }
        }

        function goToAdmin() {
            if (userEmail === 'admin@rbt.com') {
                // Redirect to admin with cache busting
                window.location.href = 'admin.html?v=' + new Date().getTime();
            } else {
                alert('Akses ditolak. Hanya administrator yang dapat mengakses halaman admin.');
            }
        }

        // Dapatkan kelas berdasarkan role
        function getClassesForUser(role, email) {
            const classes = [];
            
            if (role === 'admin') {
                // Admin akan diarahkan ke admin.html
                setTimeout(() => {
                    if (email === 'admin@rbt.com') {
                        window.location.href = 'admin.html?v=' + new Date().getTime();
                    }
                }, 1000);
                return classes;
            }
            
            if (role === 'guru_kelas') {
                const match = email.match(/kelas(\d+)([a-zA-Z])/i);
                if (match) {
                    const angka = match[1];
                    const huruf = match[2].toUpperCase();
                    classes.push(`${angka}${huruf}`);
                }
                return classes;
            }
            
            if (role === 'guru_pjok') {
                if (email === 'pjok1@rbt.com') {
                    return generateClassRange(1, 2, 'A', 'E');
                } else if (email === 'pjok2@rbt.com') {
                    return generateClassRange(3, 4, 'A', 'F');
                } else if (email === 'pjok3@rbt.com') {
                    return generateClassRange(5, 6, 'A', 'E');
                }
            }
            
            return classes;
        }

        // Generate range kelas
        function generateClassRange(startGrade, endGrade, startLetter, endLetter) {
            const classes = [];
            for (let grade = startGrade; grade <= endGrade; grade++) {
                let start = startLetter.charCodeAt(0);
                let end = endLetter.charCodeAt(0);
                
                for (let letter = start; letter <= end; letter++) {
                    if (grade === 1 && String.fromCharCode(letter) > 'D') continue;
                    if (grade === 4 && String.fromCharCode(letter) > 'F') continue;
                    if (grade !== 4 && String.fromCharCode(letter) > 'E') continue;
                    
                    classes.push(`${grade}${String.fromCharCode(letter)}`);
                }
            }
            return classes;
        }

        // Update info pengguna
        function updateUserInfo() {
            const welcomeText = document.getElementById('welcomeText');
            const userInfo = document.getElementById('userInfo');
            
            let roleText = '';
            switch(userRole) {
                case 'admin':
                    roleText = 'üëë Administrator';
                    welcomeText.textContent = `Selamat datang, Administrator!`;
                    break;
                case 'guru_kelas':
                    roleText = 'üë®‚Äçüè´ Guru Kelas';
                    welcomeText.textContent = `Selamat datang, Guru Kelas!`;
                    break;
                case 'guru_pjok':
                    roleText = 'üèÉ Guru PJOK';
                    welcomeText.textContent = `Selamat datang, Guru PJOK!`;
                    break;
                default:
                    roleText = 'Pengguna';
                    welcomeText.textContent = `Selamat datang!`;
            }
            
            userInfo.innerHTML = `<span class="role-badge">${roleText}</span> | ${userEmail}`;
        }

        // Load kelas pengguna
        function loadUserClasses() {
            // Check cache first
            const cachedClasses = localStorage.getItem('userClassesCache');
            if (cachedClasses) {
                userClasses = JSON.parse(cachedClasses);
                displayClassesBadges(userClasses);
                return;
            }
            
            userClasses = getClassesForUser(userRole, userEmail);
            const classesBadges = document.getElementById('classesBadges');
            
            if (userRole === 'admin') {
                // Admin: deteksi semua kelas dari database
                database.ref('students').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            userClasses = Object.keys(data).filter(key => /^\d+[A-Za-z]$/.test(key));
                            displayClassesBadges(userClasses);
                            // Cache the result
                            localStorage.setItem('userClassesCache', JSON.stringify(userClasses));
                        } else {
                            classesBadges.innerHTML = '<span class="class-badge">Semua Kelas</span>';
                        }
                    })
                    .catch((error) => {
                        console.log("Tidak ada data kelas:", error);
                        classesBadges.innerHTML = '<span class="class-badge">Semua Kelas</span>';
                    });
            } else {
                displayClassesBadges(userClasses);
                // Cache the result
                localStorage.setItem('userClassesCache', JSON.stringify(userClasses));
            }
        }

        // Tampilkan badge kelas
        function displayClassesBadges(classes) {
            const classesBadges = document.getElementById('classesBadges');
            
            if (classes.length === 0) {
                classesBadges.innerHTML = '<span class="class-badge">Semua Kelas</span>';
                return;
            }
            
            let badgesHTML = '';
            classes.forEach(className => {
                badgesHTML += `<span class="class-badge">Kelas ${className}</span>`;
            });
            
            classesBadges.innerHTML = badgesHTML;
        }

        // Load statistik dashboard
        async function loadDashboardStats() {
            console.log("Memuat statistik dashboard...");
            
            // Check cache first
            const cachedStats = localStorage.getItem('statsCache');
            if (cachedStats) {
                const stats = JSON.parse(cachedStats);
                updateStatsUI(stats);
                
                // Still load fresh data in background
                setTimeout(() => loadFreshStats(), 1000);
                return;
            }
            
            // Reset UI first
            resetStatsUI();
            
            if (userRole === 'admin') {
                // Admin: hitung semua data
                await loadStatsForAdmin();
            } else {
                // Non-admin: hitung berdasarkan kelas yang diampu
                await loadStatsForUser();
            }
            
            // Cache the results
            const stats = {
                totalSiswa: document.getElementById('totalSiswa').textContent,
                absensiHariIni: document.getElementById('absensiHariIni').textContent,
                nilaiMasuk: document.getElementById('nilaiMasuk').textContent,
                rataRataNilai: document.getElementById('rataRataNilai').textContent,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('statsCache', JSON.stringify(stats));
        }
        
        function resetStatsUI() {
            document.getElementById('totalSiswa').textContent = '0';
            document.getElementById('absensiHariIni').textContent = '0';
            document.getElementById('nilaiMasuk').textContent = '0';
            document.getElementById('rataRataNilai').textContent = '0';
        }
        
        function updateStatsUI(stats) {
            document.getElementById('totalSiswa').textContent = stats.totalSiswa || '0';
            document.getElementById('absensiHariIni').textContent = stats.absensiHariIni || '0';
            document.getElementById('nilaiMasuk').textContent = stats.nilaiMasuk || '0';
            document.getElementById('rataRataNilai').textContent = stats.rataRataNilai || '0';
        }
        
        async function loadFreshStats() {
            console.log("Memuat data statistik terbaru...");
            if (userRole === 'admin') {
                await loadStatsForAdmin();
            } else {
                await loadStatsForUser();
            }
        }

        // Load statistik untuk admin
        async function loadStatsForAdmin() {
            try {
                // Total siswa dari semua kelas
                const studentsRef = database.ref('students');
                const studentsSnapshot = await studentsRef.once('value');
                
                let totalStudents = 0;
                if (studentsSnapshot.exists()) {
                    const studentsData = studentsSnapshot.val();
                    Object.keys(studentsData).forEach(className => {
                        if (studentsData[className]) {
                            totalStudents += Object.keys(studentsData[className]).length;
                        }
                    });
                }
                document.getElementById('totalSiswa').textContent = totalStudents;
                
                // Absensi hari ini dari semua kelas
                const attendanceRef = database.ref('attendance');
                const attendanceSnapshot = await attendanceRef.once('value');
                
                let todayAttendance = 0;
                if (attendanceSnapshot.exists()) {
                    const attendanceData = attendanceSnapshot.val();
                    Object.keys(attendanceData).forEach(className => {
                        if (attendanceData[className] && attendanceData[className][today]) {
                            todayAttendance += Object.keys(attendanceData[className][today]).length;
                        }
                    });
                }
                document.getElementById('absensiHariIni').textContent = todayAttendance;
                
                // Nilai masuk dari semua kelas
                const nilaiRef = database.ref('penilaian');
                const nilaiSnapshot = await nilaiRef.once('value');
                
                let nilaiCount = 0;
                let totalNilai = 0;
                let nilaiEntries = 0;
                
                if (nilaiSnapshot.exists()) {
                    const nilaiData = nilaiSnapshot.val();
                    
                    Object.keys(nilaiData).forEach(className => {
                        if (nilaiData[className]) {
                            Object.keys(nilaiData[className]).forEach(semester => {
                                if (nilaiData[className][semester]) {
                                    nilaiCount += Object.keys(nilaiData[className][semester]).length;
                                    
                                    // Hitung rata-rata
                                    Object.keys(nilaiData[className][semester]).forEach(studentId => {
                                        const studentNilai = nilaiData[className][semester][studentId];
                                        if (studentNilai.nilai_total) {
                                            totalNilai += studentNilai.nilai_total;
                                            nilaiEntries++;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                document.getElementById('nilaiMasuk').textContent = nilaiCount;
                
                // Rata-rata nilai
                const averageNilai = nilaiEntries > 0 ? (totalNilai / nilaiEntries).toFixed(1) : 0;
                document.getElementById('rataRataNilai').textContent = averageNilai;
                
            } catch (error) {
                console.error("Error loading admin stats:", error);
            }
        }

        // Load statistik untuk user (non-admin)
        async function loadStatsForUser() {
            if (userClasses.length === 0) return;
            
            try {
                let totalStudents = 0;
                let todayAttendance = 0;
                let nilaiCount = 0;
                let totalNilai = 0;
                let nilaiEntries = 0;
                
                // Proses setiap kelas
                for (const className of userClasses) {
                    // Total siswa
                    const studentsRef = database.ref(`students/${className}`);
                    const studentsSnapshot = await studentsRef.once('value');
                    
                    if (studentsSnapshot.exists()) {
                        const studentsData = studentsSnapshot.val();
                        totalStudents += Object.keys(studentsData).length;
                    }
                    
                    // Absensi hari ini
                    const attendanceRef = database.ref(`attendance/${className}/${today}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    
                    if (attendanceSnapshot.exists()) {
                        const attendanceData = attendanceSnapshot.val();
                        todayAttendance += Object.keys(attendanceData).length;
                    }
                    
                    // Nilai (cek semua semester)
                    const nilaiRef = database.ref(`penilaian/${className}`);
                    const nilaiSnapshot = await nilaiRef.once('value');
                    
                    if (nilaiSnapshot.exists()) {
                        const nilaiData = nilaiSnapshot.val();
                        
                        Object.keys(nilaiData).forEach(semester => {
                            if (nilaiData[semester]) {
                                nilaiCount += Object.keys(nilaiData[semester]).length;
                                
                                // Hitung rata-rata
                                Object.keys(nilaiData[semester]).forEach(studentId => {
                                    const studentNilai = nilaiData[semester][studentId];
                                    if (studentNilai.nilai_total) {
                                        totalNilai += studentNilai.nilai_total;
                                        nilaiEntries++;
                                    }
                                });
                            }
                        });
                    }
                }
                
                // Update UI
                document.getElementById('totalSiswa').textContent = totalStudents;
                document.getElementById('absensiHariIni').textContent = todayAttendance;
                document.getElementById('nilaiMasuk').textContent = nilaiCount;
                
                // Rata-rata nilai
                const averageNilai = nilaiEntries > 0 ? (totalNilai / nilaiEntries).toFixed(1) : 0;
                document.getElementById('rataRataNilai').textContent = averageNilai;
                
            } catch (error) {
                console.error("Error loading user stats:", error);
            }
        }

        // Load aktivitas terbaru
        async function loadRecentActivities() {
            const activityList = document.getElementById('activityList');
            
            // Check cache first
            const cachedActivities = localStorage.getItem('activitiesCache');
            if (cachedActivities) {
                const activities = JSON.parse(cachedActivities);
                displayActivities(activities);
                
                // Still load fresh activities in background
                setTimeout(() => loadFreshActivities(), 1000);
                return;
            }
            
            try {
                let allActivities = [];
                
                if (userRole === 'admin') {
                    // Admin: ambil aktivitas dari semua kelas
                    allActivities = await getAdminActivities();
                } else {
                    // User: ambil aktivitas dari kelas yang diampu
                    allActivities = await getUserActivities();
                }
                
                // Urutkan berdasarkan waktu (terbaru dulu)
                allActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Ambil 10 aktivitas terbaru
                const recentActivities = allActivities.slice(0, 10);
                
                // Cache activities
                localStorage.setItem('activitiesCache', JSON.stringify(recentActivities));
                
                // Tampilkan aktivitas
                displayActivities(recentActivities);
                
            } catch (error) {
                console.error("Error loading activities:", error);
                activityList.innerHTML = `
                    <div class="no-activity">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Gagal memuat aktivitas</p>
                    </div>
                `;
            }
        }
        
        async function loadFreshActivities() {
            console.log("Memuat aktivitas terbaru...");
            try {
                let allActivities = [];
                
                if (userRole === 'admin') {
                    allActivities = await getAdminActivities();
                } else {
                    allActivities = await getUserActivities();
                }
                
                allActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const recentActivities = allActivities.slice(0, 10);
                
                localStorage.setItem('activitiesCache', JSON.stringify(recentActivities));
                displayActivities(recentActivities);
                
            } catch (error) {
                console.error("Error refreshing activities:", error);
            }
        }

        // Ambil aktivitas untuk admin
        async function getAdminActivities() {
            const activities = [];
            
            // Ambil data penilaian terbaru
            const nilaiRef = database.ref('penilaian');
            const nilaiSnapshot = await nilaiRef.once('value');
            
            if (nilaiSnapshot.exists()) {
                const nilaiData = nilaiSnapshot.val();
                
                Object.keys(nilaiData).forEach(className => {
                    if (nilaiData[className]) {
                        Object.keys(nilaiData[className]).forEach(semester => {
                            if (nilaiData[className][semester]) {
                                Object.keys(nilaiData[className][semester]).forEach(studentId => {
                                    const nilai = nilaiData[className][semester][studentId];
                                    if (nilai.updatedAt) {
                                        activities.push({
                                            type: 'penilaian',
                                            title: `Nilai diperbarui`,
                                            description: `${nilai.studentName || 'Siswa'} - Kelas ${className} (Semester ${semester})`,
                                            timestamp: nilai.updatedAt,
                                            teacher: nilai.teacher || 'Guru'
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }
            
            // Ambil data absensi hari ini
            const attendanceRef = database.ref('attendance');
            const attendanceSnapshot = await attendanceRef.once('value');
            
            if (attendanceSnapshot.exists()) {
                const attendanceData = attendanceSnapshot.val();
                
                Object.keys(attendanceData).forEach(className => {
                    if (attendanceData[className] && attendanceData[className][today]) {
                        const todayData = attendanceData[className][today];
                        const absensiCount = Object.keys(todayData).length;
                        
                        if (absensiCount > 0) {
                            activities.push({
                                type: 'absensi',
                                title: `Absensi hari ini`,
                                description: `${absensiCount} siswa di Kelas ${className}`,
                                timestamp: new Date().toISOString(),
                                teacher: 'System'
                            });
                        }
                    }
                });
            }
            
            return activities;
        }

        // Ambil aktivitas untuk user (non-admin)
        async function getUserActivities() {
            const activities = [];
            
            if (userClasses.length === 0) return activities;
            
            // Proses setiap kelas
            for (const className of userClasses) {
                // Ambil data penilaian terbaru
                const nilaiRef = database.ref(`penilaian/${className}`);
                const nilaiSnapshot = await nilaiRef.once('value');
                
                if (nilaiSnapshot.exists()) {
                    const nilaiData = nilaiSnapshot.val();
                    
                    Object.keys(nilaiData).forEach(semester => {
                        if (nilaiData[semester]) {
                            Object.keys(nilaiData[semester]).forEach(studentId => {
                                const nilai = nilaiData[semester][studentId];
                                if (nilai.updatedAt) {
                                    activities.push({
                                        type: 'penilaian',
                                        title: `Nilai diperbarui`,
                                        description: `${nilai.studentName || 'Siswa'} - Kelas ${className} (Semester ${semester})`,
                                        timestamp: nilai.updatedAt,
                                        teacher: nilai.teacher || 'Guru'
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Ambil data absensi hari ini
                const attendanceRef = database.ref(`attendance/${className}/${today}`);
                const attendanceSnapshot = await attendanceRef.once('value');
                
                if (attendanceSnapshot.exists()) {
                    const attendanceData = attendanceSnapshot.val();
                    const absensiCount = Object.keys(attendanceData).length;
                    
                    if (absensiCount > 0) {
                        activities.push({
                            type: 'absensi',
                            title: `Absensi hari ini`,
                            description: `${absensiCount} siswa di Kelas ${className}`,
                            timestamp: new Date().toISOString(),
                            teacher: userEmail
                        });
                    }
                }
            }
            
            return activities;
        }

        // Tampilkan aktivitas di UI
        function displayActivities(activities) {
            const activityList = document.getElementById('activityList');
            
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <div class="no-activity">
                        <i class="fas fa-history"></i>
                        <p>Belum ada aktivitas terbaru</p>
                        <small>Mulai dengan melakukan absensi atau penilaian</small>
                    </div>
                `;
                return;
            }
            
            let activitiesHTML = '';
            
            activities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const icon = activity.type === 'absensi' ? 'fa-clipboard-check' : 'fa-graduation-cap';
                const iconClass = activity.type === 'absensi' ? 'absensi' : 'penilaian';
                
                activitiesHTML += `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-desc">${activity.description}</div>
                            <div class="activity-time">
                                <i class="far fa-clock"></i> ${timeAgo} ‚Ä¢ Oleh: ${activity.teacher}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityList.innerHTML = activitiesHTML;
        }

        // Format waktu relatif (time ago)
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'baru saja';
            if (diffMins < 60) return `${diffMins} menit yang lalu`;
            if (diffHours < 24) return `${diffHours} jam yang lalu`;
            if (diffDays < 7) return `${diffDays} hari yang lalu`;
            
            return past.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // ============================================
        // FUNGSI LAINNYA
        // ============================================

        // Export laporan
        function exportLaporan() {
            alert("Fitur export laporan akan segera tersedia!");
            // Implementasi export ke Excel/PDF bisa ditambahkan di sini
        }

        // Logout
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                auth.signOut().then(() => {
                    // Clear all cache
                    localStorage.clear();
                    sessionStorage.clear();
                    // Redirect with cache busting
                    window.location.href = 'index.html?v=' + new Date().getTime();
                }).catch((error) => {
                    console.error("Error logging out:", error);
                    alert("Gagal logout, silakan coba lagi.");
                });
            }
        }

        // Refresh dashboard (bisa dipanggil dari halaman lain)
        function refreshDashboard() {
            console.log("üîÑ Refreshing dashboard...");
            loadDashboardStats();
            loadRecentActivities();
        }

        // ============================================
        // SAVE APP VERSION TO CACHE
        // ============================================
        localStorage.setItem('appVersion', appVersion);
        localStorage.setItem('cacheTimestamp', new Date().getTime().toString());

        // ============================================
        // EXPOSE FUNGSI KE GLOBAL
        // ============================================
        window.logout = logout;
        window.exportLaporan = exportLaporan;
        window.refreshDashboard = refreshDashboard;
        window.clearCache = clearCache;
        window.goToAdmin = goToAdmin;
        
        console.log("‚úÖ Dashboard initialized successfully");
    </script>
</body>
</html>