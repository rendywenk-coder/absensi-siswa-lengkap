<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- HAPUS META CACHE CONTROL YANG MENYEBABKAN MASALAH -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SDN RAWABUNTU 03</title>
    <link rel="stylesheet" href="style.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- üî• FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- INCLUDE FIREBASE-APP.JS (SINGLE SOURCE OF TRUTH) -->
    <script src="firebase-app.js?v=2"></script>
    
    <style>
        /* Dashboard specific styles */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .welcome-text {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .role-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #eef2f7;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-card.blue i { color: #3498db; }
        .stat-card.green i { color: #2ecc71; }
        .stat-card.orange i { color: #e67e22; }
        .stat-card.purple i { color: #9b59b6; }
        
        .stat-card.blue { border-top: 4px solid #3498db; }
        .stat-card.green { border-top: 4px solid #2ecc71; }
        .stat-card.orange { border-top: 4px solid #e67e22; }
        .stat-card.purple { border-top: 4px solid #9b59b6; }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            border: 2px solid #eef2f7;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
        }
        
        .action-btn:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(52, 152, 219, 0.1);
        }
        
        .action-btn i {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            color: white;
        }
        
        .action-btn.absensi i { background: #3498db; }
        .action-btn.penilaian i { background: #2ecc71; }
        .action-btn.monitoring i { background: #9b59b6; }
        .action-btn.laporan i { background: #e74c3c; }
        
        .action-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .action-text p {
            margin: 0;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
            border: 1px solid #eef2f7;
        }
        
        .recent-activity h2 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.3s;
        }
        
        .activity-item:hover {
            background: #f9f9f9;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .activity-icon.absensi { background: #3498db; }
        .activity-icon.penilaian { background: #2ecc71; }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: #2c3e50;
        }
        
        .activity-desc {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: #95a5a6;
        }
        
        .no-activity {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        
        .no-activity i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ecf0f1;
        }
        
        .loading-activity {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .classes-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .class-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .export-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .export-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .export-content p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .export-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* KONEKSI NOTIFICATION SYSTEM - DIPERBAIKI */
        .connection-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            transition: all 0.3s;
            opacity: 1;
            transform: translateX(0);
        }
        
        .connection-notification.hidden {
            transform: translateX(150%);
            opacity: 0;
            pointer-events: none;
        }
        
        .connection-notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-left: 5px solid #ff7675;
        }
        
        .connection-notification.success {
            background: linear-gradient(135deg, #27ae60, #219a52);
            border-left: 5px solid #2ecc71;
        }
        
        .connection-notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-left: 5px solid #f1c40f;
        }
        
        .connection-notification.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-left: 5px solid #3498db;
        }
        
        .connection-icon {
            font-size: 1.5rem;
            min-width: 30px;
        }
        
        .connection-content {
            flex: 1;
        }
        
        .connection-content h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
        }
        
        .connection-content p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .connection-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .connection-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Footer */
        .dashboard-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eef2f7;
            color: #95a5a6;
            font-size: 0.85rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .export-section {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .connection-notification {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                padding: 20px 15px;
            }
            
            .welcome-text {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Notification System -->
    <div id="connectionNotification" class="connection-notification hidden">
        <div class="connection-icon">
            <i class="fas fa-wifi"></i>
        </div>
        <div class="connection-content">
            <h4 id="connectionTitle">Koneksi Internet</h4>
            <p id="connectionMessage">Memeriksa koneksi...</p>
        </div>
        <button class="connection-close" onclick="hideConnectionNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">
            SDN RAWABUNTU 03
            <span style="font-size: 11px; color: #7f8c8d;"> | Dashboard</span>
        </div>
        <div class="navbar-user">
            <span id="userName">Memuat...</span>
            <button onclick="refreshDashboard()" class="btn btn-warning" style="padding: 6px 12px; font-size: 0.85rem; margin-right: 10px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button onclick="logout()" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="welcome-text" id="welcomeText">Selamat datang!</div>
            <p id="userInfo">Memuat informasi pengguna...</p>
            <div class="classes-badges" id="classesBadges">
                <!-- Kelas akses akan dimuat di sini -->
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <i class="fas fa-users"></i>
                <div class="stat-number" id="totalSiswa">0</div>
                <div class="stat-label">Total Siswa</div>
            </div>
            
            <div class="stat-card green">
                <i class="fas fa-calendar-check"></i>
                <div class="stat-number" id="absensiHariIni">0</div>
                <div class="stat-label">Absensi Hari Ini</div>
            </div>
            
            <div class="stat-card orange">
                <i class="fas fa-chart-bar"></i>
                <div class="stat-number" id="nilaiMasuk">0</div>
                <div class="stat-label">Nilai Masuk</div>
            </div>
            
            <div class="stat-card purple">
                <i class="fas fa-percentage"></i>
                <div class="stat-number" id="rataRataNilai">0</div>
                <div class="stat-label">Rata-rata Nilai</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="absensi.html?v=2" class="action-btn absensi">
                <i class="fas fa-clipboard-check"></i>
                <div class="action-text">
                    <h3>Absensi</h3>
                    <p>Input absensi harian siswa dengan QR Code atau manual</p>
                </div>
            </a>
            
            <a href="penilaian.html?v=2" class="action-btn penilaian">
                <i class="fas fa-graduation-cap"></i>
                <div class="action-text">
                    <h3>Penilaian</h3>
                    <p>Input nilai harian, sumatif, dan nilai akhir siswa</p>
                </div>
            </a>
            
            <a href="monitoring.html?v=2" class="action-btn monitoring">
                <i class="fas fa-chart-line"></i>
                <div class="action-text">
                    <h3>Monitoring</h3>
                    <p>Pantau statistik dan perkembangan siswa secara real-time</p>
                </div>
            </a>
            
            <a href="javascript:void(0)" onclick="exportLaporan()" class="action-btn laporan">
                <i class="fas fa-file-export"></i>
                <div class="action-text">
                    <h3>Export Laporan</h3>
                    <p>Download laporan dalam format Excel atau PDF</p>
                </div>
            </a>
        </div>
        
        <!-- Recent Activity -->
        <div class="recent-activity">
            <h2><i class="fas fa-history"></i> Aktivitas Terbaru</h2>
            <div class="activity-list" id="activityList">
                <div class="loading-activity">
                    <div class="loading-spinner"></div>
                    <p>Memuat aktivitas...</p>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <div class="export-content">
                <h3><i class="fas fa-download"></i> Export Laporan</h3>
                <p>Download laporan dalam format Excel atau PDF</p>
            </div>
            <button onclick="exportLaporan()" class="export-btn">
                <i class="fas fa-download"></i> Download Laporan
            </button>
        </div>
        
        <!-- Admin Access Button (Hidden for non-admin) -->
        <div id="adminAccess" style="display: none; margin-top: 20px;">
            <div class="export-section" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);">
                <div class="export-content">
                    <h3><i class="fas fa-user-shield"></i> Akses Administrator</h3>
                    <p>Akses halaman admin untuk manajemen data lengkap</p>
                </div>
                <button onclick="goToAdmin()" class="export-btn" style="color: #3498db;">
                    <i class="fas fa-cogs"></i> Buka Panel Admin
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="dashboard-footer">
            ¬© 2024 SDN Rawabuntu 03 - Sistem Absensi & Penilaian<br>
            <small>Versi: 2.0 | Terakhir diperbarui: <span id="lastUpdated"></span></small>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentUser = null;
        let auth = null;
        let database = null;
        let userRole = '';
        let userEmail = '';
        let userClasses = [];
        let today = new Date().toISOString().split('T')[0];
        let isPageInitialized = false;
        let realtimeUnsubscribe = null;
        let lastConnectionStatus = null;

        // ============================================
        // CONNECTION SYSTEM FUNCTIONS
        // ============================================
        function showConnectionNotification(type, title, message, autoHide = true) {
            const notification = document.getElementById('connectionNotification');
            const titleElement = document.getElementById('connectionTitle');
            const messageElement = document.getElementById('connectionMessage');
            const icon = notification.querySelector('.connection-icon i');
            
            // Only show if status changed
            if (type === 'success' && lastConnectionStatus === true) {
                return; // Don't show success if already connected
            }
            
            // Remove all classes
            notification.className = 'connection-notification';
            notification.classList.add(type);
            
            // Set content
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Set icon based on type
            switch(type) {
                case 'error':
                    icon.className = 'fas fa-wifi-slash';
                    break;
                case 'success':
                    icon.className = 'fas fa-wifi';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    icon.className = 'fas fa-info-circle';
                    break;
            }
            
            // Show notification
            notification.classList.remove('hidden');
            
            // Auto hide for success messages
            if (autoHide && type === 'success') {
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            }
            
            // Update last connection status
            if (type === 'success') lastConnectionStatus = true;
            if (type === 'error') lastConnectionStatus = false;
        }

        function hideConnectionNotification() {
            const notification = document.getElementById('connectionNotification');
            notification.classList.add('hidden');
        }

        async function checkConnection() {
            try {
                // Quick browser check first
                if (!navigator.onLine) {
                    if (lastConnectionStatus !== false) {
                        showConnectionNotification(
                            'error',
                            'Anda Offline',
                            'Browser Anda tidak terhubung ke internet',
                            false
                        );
                        lastConnectionStatus = false;
                    }
                    return false;
                }

                // Check Firebase connection
                if (!database) {
                    if (lastConnectionStatus !== false) {
                        showConnectionNotification(
                            'error',
                            'Database Error',
                            'Database tidak tersedia',
                            false
                        );
                        lastConnectionStatus = false;
                    }
                    return false;
                }

                let firebaseConnected = false;
                
                // Try to check Firebase connection
                try {
                    const connectedRef = database.ref('.info/connected');
                    const snapshot = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            connectedRef.off('value');
                            resolve(false);
                        }, 2000);
                        
                        connectedRef.on('value', (snap) => {
                            clearTimeout(timeout);
                            connectedRef.off('value');
                            resolve(snap.val() === true);
                        });
                    });
                    
                    firebaseConnected = snapshot;
                } catch (e) {
                    console.log("Firebase connection check error:", e);
                    firebaseConnected = false;
                }

                const isConnected = firebaseConnected;

                // Only notify if status changed
                if (isConnected !== lastConnectionStatus) {
                    if (isConnected) {
                        showConnectionNotification(
                            'success',
                            'Koneksi Normal',
                            'Terhubung ke database dengan baik',
                            true
                        );
                    } else {
                        showConnectionNotification(
                            'error',
                            'Database Offline',
                            'Tidak dapat terhubung ke database',
                            false
                        );
                    }
                    lastConnectionStatus = isConnected;
                }

                return isConnected;

            } catch (error) {
                console.error('Error checking connection:', error);
                
                if (lastConnectionStatus !== false) {
                    showConnectionNotification(
                        'error',
                        'Kesalahan Sistem',
                        'Gagal memeriksa koneksi',
                        false
                    );
                    lastConnectionStatus = false;
                }
                
                return false;
            }
        }

        function startConnectionMonitoring() {
            // Check immediately
            checkConnection();
            
            // Check every 30 seconds
            setInterval(() => {
                checkConnection();
            }, 30000);
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                console.log('Browser online, checking connection...');
                checkConnection();
            });
            
            window.addEventListener('offline', () => {
                console.log('Browser offline');
                showConnectionNotification('error', 'Anda Offline', 'Browser Anda tidak terhubung ke internet', false);
                lastConnectionStatus = false;
            });
        }

        // ============================================
        // REALTIME UPDATES SYSTEM - DITAMBAHKAN
        // ============================================
        function setupRealtimeUpdates() {
            console.log("üîÑ Setting up realtime updates for dashboard...");
            
            // Clean up previous listeners
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
            
            // Setup realtime stats updates jika ada
            if (window.firebaseApp && window.firebaseApp.getRealtimeStats) {
                realtimeUnsubscribe = window.firebaseApp.getRealtimeStats((stats) => {
                    console.log("üìä Realtime stats updated:", stats);
                    updateDashboardStats(stats);
                });
            }
            
            // Listen for Firebase connection changes
            window.addEventListener('firebaseConnectionChange', (event) => {
                const isConnected = event.detail.connected;
                console.log("üîå Firebase connection changed:", isConnected);
                
                if (isConnected) {
                    showConnectionNotification('success', 'Database Online', 'Terhubung ke database realtime', true);
                    // Refresh data when reconnected
                    setTimeout(() => {
                        loadDashboardStats();
                        loadRecentActivities();
                    }, 1000);
                } else {
                    showConnectionNotification('error', 'Database Offline', 'Tidak terhubung ke database', false);
                }
            });
            
            // Listen for data update events
            window.addEventListener('studentsUpdated', () => {
                console.log("üë• Students data updated event - refreshing stats");
                loadDashboardStats();
            });
            
            window.addEventListener('attendanceUpdated', () => {
                console.log("üìÖ Attendance data updated event - refreshing stats");
                loadDashboardStats();
                loadRecentActivities();
            });
            
            window.addEventListener('scoresUpdated', () => {
                console.log("üìä Scores data updated event - refreshing stats");
                loadDashboardStats();
                loadRecentActivities();
            });
            
            console.log("‚úÖ Realtime updates setup complete");
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalSiswa').textContent = stats.totalStudents || 0;
            document.getElementById('absensiHariIni').textContent = stats.attendanceRate || 0;
            document.getElementById('rataRataNilai').textContent = stats.averageScore || 0;
            
            // Hitung nilai masuk dari stats yang tersedia
            if (stats.totalStudents && stats.attendanceRate) {
                const nilaiMasuk = Math.floor((stats.totalStudents * stats.attendanceRate) / 100);
                document.getElementById('nilaiMasuk').textContent = nilaiMasuk;
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Dashboard initializing...");
            
            // Set last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Initialize with delay to ensure Firebase is loaded
            setTimeout(initializeDashboardSystem, 1000);
        });

        async function initializeDashboardSystem() {
            if (isPageInitialized) {
                console.log("‚ö†Ô∏è Dashboard already initialized");
                return;
            }
            
            try {
                console.log("üî• Initializing dashboard system...");
                
                // Check if Firebase is available
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase not loaded");
                    showConnectionNotification('error', 'Firebase Error', 'Firebase SDK tidak dimuat', false);
                    return;
                }
                
                // Use firebase-app.js if available
                if (window.firebaseApp && window.firebaseApp.isInitialized) {
                    console.log("‚úÖ Using firebase-app.js");
                    auth = window.firebaseApp.getAuth();
                    database = window.firebaseApp.getDatabase();
                } else {
                    console.log("‚ö†Ô∏è Initializing Firebase directly");
                    // Initialize Firebase
                    const firebaseConfig = {
                        apiKey: "AIzaSyD_0hKhrz0vC7X_9KRrXiTOnRGI9Pi6tBI",
                        authDomain: "absensi-dan-penilaian-siswa.firebaseapp.com",
                        databaseURL: "https://absensi-dan-penilaian-siswa-default-rtdb.asia-southeast1.firebasedatabase.app",
                        projectId: "absensi-dan-penilaian-siswa",
                        storageBucket: "absensi-dan-penilaian-siswa.appspot.com",
                        messagingSenderId: "774655798848",
                        appId: "1:774655798848:web:d6ddb5a04d4acd91d1b9a5"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    auth = firebase.auth();
                    database = firebase.database();
                }
                
                if (!auth || !database) {
                    throw new Error("Failed to get Firebase services");
                }
                
                console.log("‚úÖ Firebase services ready");
                
                // Setup auth state listener
                auth.onAuthStateChanged(handleAuthStateChange);
                
            } catch (error) {
                console.error("‚ùå Error initializing:", error);
                showConnectionNotification('error', 'Inisialisasi Gagal', error.message, false);
            }
        }

        async function handleAuthStateChange(user) {
            if (!user) {
                console.log("‚ö†Ô∏è No user, redirecting to login...");
                setTimeout(() => {
                    if (!currentUser) {
                        window.location.href = 'index.html';
                    }
                }, 1000);
                return;
            }
            
            currentUser = user;
            userEmail = user.email;
            userRole = detectRoleFromEmail(userEmail);
            
            document.getElementById('userName').textContent = user.email;
            
            console.log("‚úÖ User authenticated:", user.email, "Role:", userRole);
            
            // Start connection monitoring
            startConnectionMonitoring();
            
            // Initialize page only once
            if (!isPageInitialized) {
                initializeDashboardPage();
                isPageInitialized = true;
            }
            
            // Load initial data
            loadInitialData();
        }

        // ============================================
        // DASHBOARD PAGE FUNCTIONS
        // ============================================
        function initializeDashboardPage() {
            console.log("‚úÖ Initializing dashboard page...");
            
            // Setup realtime updates
            setupRealtimeUpdates();
            
            console.log("‚úÖ Dashboard page ready");
        }

        async function loadInitialData() {
            try {
                console.log("üìä Loading initial data...");
                
                // Update user info
                updateUserInfo();
                
                // Load user classes
                await loadUserClasses();
                
                // Load dashboard stats
                await loadDashboardStats();
                
                // Load recent activities
                await loadRecentActivities();
                
                // Check admin access
                checkAdminAccess();
                
                console.log("‚úÖ Initial data loaded");
                
            } catch (error) {
                console.error("‚ùå Error loading initial data:", error);
            }
        }

        // Deteksi role dari email
        function detectRoleFromEmail(email) {
            if (!email) return 'unknown';
            if (email === 'admin@rbt.com') return 'admin';
            if (email.includes('kelas')) return 'guru_kelas';
            if (email.includes('pjok')) return 'guru_pjok';
            return 'unknown';
        }

        // Update info pengguna
        function updateUserInfo() {
            const welcomeText = document.getElementById('welcomeText');
            const userInfo = document.getElementById('userInfo');
            
            let roleText = '';
            switch(userRole) {
                case 'admin':
                    roleText = 'üëë Administrator';
                    welcomeText.textContent = `Selamat datang, Administrator!`;
                    break;
                case 'guru_kelas':
                    roleText = 'üë®‚Äçüè´ Guru Kelas';
                    welcomeText.textContent = `Selamat datang, Guru Kelas!`;
                    break;
                case 'guru_pjok':
                    roleText = 'üèÉ Guru PJOK';
                    welcomeText.textContent = `Selamat datang, Guru PJOK!`;
                    break;
                default:
                    roleText = 'Pengguna';
                    welcomeText.textContent = `Selamat datang!`;
            }
            
            userInfo.innerHTML = `<span class="role-badge">${roleText}</span> | ${userEmail}`;
        }

        // Load kelas pengguna
        async function loadUserClasses() {
            userClasses = getClassesForUser(userRole, userEmail);
            displayClassesBadges(userClasses);
        }

        // Dapatkan kelas berdasarkan role
        function getClassesForUser(role, email) {
            const classes = [];
            
            if (role === 'admin') {
                // Admin akan diarahkan ke admin.html (tapi tetap tampilkan badge semua kelas)
                return ['Semua Kelas'];
            }
            
            if (role === 'guru_kelas') {
                const match = email.match(/kelas(\d+)([a-zA-Z])/i);
                if (match) {
                    const angka = match[1];
                    const huruf = match[2].toUpperCase();
                    classes.push(`${angka}${huruf}`);
                }
                return classes;
            }
            
            if (role === 'guru_pjok') {
                if (email === 'pjok1@rbt.com') {
                    return generateClassRange(1, 2, 'A', 'E');
                } else if (email === 'pjok2@rbt.com') {
                    return generateClassRange(3, 4, 'A', 'F');
                } else if (email === 'pjok3@rbt.com') {
                    return generateClassRange(5, 6, 'A', 'E');
                }
            }
            
            return classes;
        }

        // Generate range kelas
        function generateClassRange(startGrade, endGrade, startLetter, endLetter) {
            const classes = [];
            for (let grade = startGrade; grade <= endGrade; grade++) {
                let start = startLetter.charCodeAt(0);
                let end = endLetter.charCodeAt(0);
                
                for (let letter = start; letter <= end; letter++) {
                    if (grade === 1 && String.fromCharCode(letter) > 'D') continue;
                    if (grade === 4 && String.fromCharCode(letter) > 'F') continue;
                    if (grade !== 4 && String.fromCharCode(letter) > 'E') continue;
                    
                    classes.push(`${grade}${String.fromCharCode(letter)}`);
                }
            }
            return classes;
        }

        // Tampilkan badge kelas
        function displayClassesBadges(classes) {
            const classesBadges = document.getElementById('classesBadges');
            
            if (classes.length === 0) {
                classesBadges.innerHTML = '<span class="class-badge">Semua Kelas</span>';
                return;
            }
            
            let badgesHTML = '';
            classes.forEach(className => {
                badgesHTML += `<span class="class-badge">Kelas ${className}</span>`;
            });
            
            classesBadges.innerHTML = badgesHTML;
        }

        // Load statistik dashboard
        async function loadDashboardStats() {
            console.log("üìä Memuat statistik dashboard...");
            
            // Reset UI first
            resetStatsUI();
            
            if (userRole === 'admin') {
                // Admin: hitung semua data
                await loadStatsForAdmin();
            } else {
                // Non-admin: hitung berdasarkan kelas yang diampu
                await loadStatsForUser();
            }
        }
        
        function resetStatsUI() {
            document.getElementById('totalSiswa').textContent = '0';
            document.getElementById('absensiHariIni').textContent = '0';
            document.getElementById('nilaiMasuk').textContent = '0';
            document.getElementById('rataRataNilai').textContent = '0';
        }

        // Load statistik untuk admin
        async function loadStatsForAdmin() {
            if (!database) {
                console.error("Database tidak tersedia");
                return;
            }
            
            try {
                // Total siswa dari semua kelas
                const studentsRef = database.ref('students');
                const studentsSnapshot = await studentsRef.once('value');
                
                let totalStudents = 0;
                if (studentsSnapshot.exists()) {
                    const studentsData = studentsSnapshot.val();
                    Object.keys(studentsData).forEach(className => {
                        if (studentsData[className]) {
                            totalStudents += Object.keys(studentsData[className]).length;
                        }
                    });
                }
                document.getElementById('totalSiswa').textContent = totalStudents;
                
                // Absensi hari ini dari semua kelas
                const attendanceRef = database.ref('attendance');
                const attendanceSnapshot = await attendanceRef.once('value');
                
                let todayAttendance = 0;
                let totalAttendancePossible = 0;
                if (attendanceSnapshot.exists()) {
                    const attendanceData = attendanceSnapshot.val();
                    Object.keys(attendanceData).forEach(className => {
                        if (attendanceData[className] && attendanceData[className][today]) {
                            const classAttendance = attendanceData[className][today];
                            Object.values(classAttendance).forEach(record => {
                                if (record && (record.status === 'hadir' || record.status === 'H' || record === 'hadir' || record === 'H')) {
                                    todayAttendance++;
                                }
                            });
                            totalAttendancePossible += Object.keys(classAttendance).length;
                        }
                    });
                }
                
                const attendanceRate = totalAttendancePossible > 0 ? 
                    Math.round((todayAttendance / totalAttendancePossible) * 100) : 0;
                document.getElementById('absensiHariIni').textContent = `${attendanceRate}%`;
                
                // Nilai masuk dari semua kelas
                const nilaiRef = database.ref('penilaian');
                const nilaiSnapshot = await nilaiRef.once('value');
                
                let nilaiCount = 0;
                let totalNilai = 0;
                let nilaiEntries = 0;
                
                if (nilaiSnapshot.exists()) {
                    const nilaiData = nilaiSnapshot.val();
                    
                    Object.keys(nilaiData).forEach(className => {
                        if (nilaiData[className]) {
                            Object.keys(nilaiData[className]).forEach(semester => {
                                if (nilaiData[className][semester]) {
                                    nilaiCount += Object.keys(nilaiData[className][semester]).length;
                                    
                                    // Hitung rata-rata
                                    Object.keys(nilaiData[className][semester]).forEach(studentId => {
                                        const studentNilai = nilaiData[className][semester][studentId];
                                        if (studentNilai && studentNilai.nilai_total) {
                                            totalNilai += parseFloat(studentNilai.nilai_total) || 0;
                                            nilaiEntries++;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                document.getElementById('nilaiMasuk').textContent = nilaiCount;
                
                // Rata-rata nilai
                const averageNilai = nilaiEntries > 0 ? (totalNilai / nilaiEntries).toFixed(1) : 0;
                document.getElementById('rataRataNilai').textContent = averageNilai;
                
            } catch (error) {
                console.error("Error loading admin stats:", error);
            }
        }

        // Load statistik untuk user (non-admin)
        async function loadStatsForUser() {
            if (userClasses.length === 0) return;
            if (!database) {
                console.error("Database tidak tersedia");
                return;
            }
            
            try {
                let totalStudents = 0;
                let todayAttendance = 0;
                let totalAttendancePossible = 0;
                let nilaiCount = 0;
                let totalNilai = 0;
                let nilaiEntries = 0;
                
                // Proses setiap kelas
                for (const className of userClasses) {
                    // Total siswa
                    const studentsRef = database.ref(`students/${className}`);
                    const studentsSnapshot = await studentsRef.once('value');
                    
                    if (studentsSnapshot.exists()) {
                        const studentsData = studentsSnapshot.val();
                        totalStudents += Object.keys(studentsData).length;
                    }
                    
                    // Absensi hari ini
                    const attendanceRef = database.ref(`attendance/${className}/${today}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    
                    if (attendanceSnapshot.exists()) {
                        const attendanceData = attendanceSnapshot.val();
                        totalAttendancePossible += Object.keys(attendanceData).length;
                        
                        Object.values(attendanceData).forEach(record => {
                            if (record && (record.status === 'hadir' || record.status === 'H' || record === 'hadir' || record === 'H')) {
                                todayAttendance++;
                            }
                        });
                    }
                    
                    // Nilai (cek semua semester)
                    const nilaiRef = database.ref(`penilaian/${className}`);
                    const nilaiSnapshot = await nilaiRef.once('value');
                    
                    if (nilaiSnapshot.exists()) {
                        const nilaiData = nilaiSnapshot.val();
                        
                        Object.keys(nilaiData).forEach(semester => {
                            if (nilaiData[semester]) {
                                nilaiCount += Object.keys(nilaiData[semester]).length;
                                
                                // Hitung rata-rata
                                Object.keys(nilaiData[semester]).forEach(studentId => {
                                    const studentNilai = nilaiData[semester][studentId];
                                    if (studentNilai && studentNilai.nilai_total) {
                                        totalNilai += parseFloat(studentNilai.nilai_total) || 0;
                                        nilaiEntries++;
                                    }
                                });
                            }
                        });
                    }
                }
                
                // Update UI
                document.getElementById('totalSiswa').textContent = totalStudents;
                
                // Hitung persentase kehadiran
                const attendanceRate = totalAttendancePossible > 0 ? 
                    Math.round((todayAttendance / totalAttendancePossible) * 100) : 0;
                document.getElementById('absensiHariIni').textContent = `${attendanceRate}%`;
                
                document.getElementById('nilaiMasuk').textContent = nilaiCount;
                
                // Rata-rata nilai
                const averageNilai = nilaiEntries > 0 ? (totalNilai / nilaiEntries).toFixed(1) : 0;
                document.getElementById('rataRataNilai').textContent = averageNilai;
                
            } catch (error) {
                console.error("Error loading user stats:", error);
            }
        }

        // Load aktivitas terbaru
        async function loadRecentActivities() {
            const activityList = document.getElementById('activityList');
            
            try {
                let allActivities = [];
                
                if (userRole === 'admin') {
                    // Admin: ambil aktivitas dari semua kelas
                    allActivities = await getAdminActivities();
                } else {
                    // User: ambil aktivitas dari kelas yang diampu
                    allActivities = await getUserActivities();
                }
                
                // Urutkan berdasarkan waktu (terbaru dulu)
                allActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Ambil 10 aktivitas terbaru
                const recentActivities = allActivities.slice(0, 10);
                
                // Tampilkan aktivitas
                displayActivities(recentActivities);
                
            } catch (error) {
                console.error("Error loading activities:", error);
                activityList.innerHTML = `
                    <div class="no-activity">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Gagal memuat aktivitas</p>
                    </div>
                `;
            }
        }

        // Ambil aktivitas untuk admin
        async function getAdminActivities() {
            const activities = [];
            
            if (!database) return activities;
            
            // Ambil data penilaian terbaru
            const nilaiRef = database.ref('penilaian');
            const nilaiSnapshot = await nilaiRef.once('value');
            
            if (nilaiSnapshot.exists()) {
                const nilaiData = nilaiSnapshot.val();
                
                Object.keys(nilaiData).forEach(className => {
                    if (nilaiData[className]) {
                        Object.keys(nilaiData[className]).forEach(semester => {
                            if (nilaiData[className][semester]) {
                                Object.keys(nilaiData[className][semester]).forEach(studentId => {
                                    const nilai = nilaiData[className][semester][studentId];
                                    if (nilai.updatedAt) {
                                        activities.push({
                                            type: 'penilaian',
                                            title: `Nilai diperbarui`,
                                            description: `${nilai.studentName || 'Siswa'} - Kelas ${className} (Semester ${semester})`,
                                            timestamp: nilai.updatedAt,
                                            teacher: nilai.teacher || 'Guru'
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }
            
            // Ambil data absensi hari ini
            const attendanceRef = database.ref('attendance');
            const attendanceSnapshot = await attendanceRef.once('value');
            
            if (attendanceSnapshot.exists()) {
                const attendanceData = attendanceSnapshot.val();
                
                Object.keys(attendanceData).forEach(className => {
                    if (attendanceData[className] && attendanceData[className][today]) {
                        const todayData = attendanceData[className][today];
                        const absensiCount = Object.keys(todayData).length;
                        
                        if (absensiCount > 0) {
                            activities.push({
                                type: 'absensi',
                                title: `Absensi hari ini`,
                                description: `${absensiCount} siswa di Kelas ${className}`,
                                timestamp: new Date().toISOString(),
                                teacher: 'System'
                            });
                        }
                    }
                });
            }
            
            return activities;
        }

        // Ambil aktivitas untuk user (non-admin)
        async function getUserActivities() {
            const activities = [];
            
            if (userClasses.length === 0) return activities;
            if (!database) return activities;
            
            // Proses setiap kelas
            for (const className of userClasses) {
                // Ambil data penilaian terbaru
                const nilaiRef = database.ref(`penilaian/${className}`);
                const nilaiSnapshot = await nilaiRef.once('value');
                
                if (nilaiSnapshot.exists()) {
                    const nilaiData = nilaiSnapshot.val();
                    
                    Object.keys(nilaiData).forEach(semester => {
                        if (nilaiData[semester]) {
                            Object.keys(nilaiData[semester]).forEach(studentId => {
                                const nilai = nilaiData[semester][studentId];
                                if (nilai && nilai.updatedAt) {
                                    activities.push({
                                        type: 'penilaian',
                                        title: `Nilai diperbarui`,
                                        description: `${nilai.studentName || 'Siswa'} - Kelas ${className} (Semester ${semester})`,
                                        timestamp: nilai.updatedAt,
                                        teacher: nilai.teacher || userEmail
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Ambil data absensi hari ini
                const attendanceRef = database.ref(`attendance/${className}/${today}`);
                const attendanceSnapshot = await attendanceRef.once('value');
                
                if (attendanceSnapshot.exists()) {
                    const attendanceData = attendanceSnapshot.val();
                    const absensiCount = Object.keys(attendanceData).length;
                    
                    if (absensiCount > 0) {
                        activities.push({
                            type: 'absensi',
                            title: `Absensi hari ini`,
                            description: `${absensiCount} siswa di Kelas ${className}`,
                            timestamp: new Date().toISOString(),
                            teacher: userEmail
                        });
                    }
                }
            }
            
            return activities;
        }

        // Tampilkan aktivitas di UI
        function displayActivities(activities) {
            const activityList = document.getElementById('activityList');
            
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <div class="no-activity">
                        <i class="fas fa-history"></i>
                        <p>Belum ada aktivitas terbaru</p>
                        <small>Mulai dengan melakukan absensi atau penilaian</small>
                    </div>
                `;
                return;
            }
            
            let activitiesHTML = '';
            
            activities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const icon = activity.type === 'absensi' ? 'fa-clipboard-check' : 'fa-graduation-cap';
                const iconClass = activity.type === 'absensi' ? 'absensi' : 'penilaian';
                
                activitiesHTML += `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-desc">${activity.description}</div>
                            <div class="activity-time">
                                <i class="far fa-clock"></i> ${timeAgo} ‚Ä¢ Oleh: ${activity.teacher}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityList.innerHTML = activitiesHTML;
        }

        // Format waktu relatif (time ago)
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'baru saja';
            if (diffMins < 60) return `${diffMins} menit yang lalu`;
            if (diffHours < 24) return `${diffHours} jam yang lalu`;
            if (diffDays < 7) return `${diffDays} hari yang lalu`;
            
            return past.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Check admin access
        function checkAdminAccess() {
            const adminAccessDiv = document.getElementById('adminAccess');
            if (userEmail === 'admin@rbt.com') {
                adminAccessDiv.style.display = 'block';
            } else {
                adminAccessDiv.style.display = 'none';
            }
        }

        // ============================================
        // FUNGSI UTILITY
        // ============================================

        // Go to admin page
        function goToAdmin() {
            if (userEmail === 'admin@rbt.com') {
                window.location.href = 'admin.html?v=' + new Date().getTime();
            } else {
                alert('Akses ditolak. Hanya administrator yang dapat mengakses halaman admin.');
            }
        }

        // Export laporan
        function exportLaporan() {
            alert("Fitur export laporan akan segera tersedia!");
        }

        // Refresh dashboard
        function refreshDashboard() {
            console.log("üîÑ Refreshing dashboard...");
            loadDashboardStats();
            loadRecentActivities();
            showConnectionNotification('success', 'Diperbarui', 'Data dashboard diperbarui', true);
        }

        // Logout
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                // Clean up realtime listeners
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }
                
                if (window.firebaseApp && window.firebaseApp.removeAllListeners) {
                    window.firebaseApp.removeAllListeners();
                }
                
                auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    showConnectionNotification('error', 'Gagal', 'Gagal logout', false);
                });
            }
        }

        // ============================================
        // EXPOSE FUNCTIONS
        // ============================================
        window.logout = logout;
        window.exportLaporan = exportLaporan;
        window.refreshDashboard = refreshDashboard;
        window.goToAdmin = goToAdmin;
        window.hideConnectionNotification = hideConnectionNotification;
    </script>
</body>
</html>